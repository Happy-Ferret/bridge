(function(n){if("object"===typeof exports&&"undefined"!==typeof module)module.b=n();else if("function"===typeof define&&define.la)define([],n);else{var h;"undefined"!==typeof window?h=window:"undefined"!==typeof global?h=global:"undefined"!==typeof self?h=self:h=this;h.oa=n()}})(function(){return function h(d,f,g){function k(e,b){if(!f[e]){if(!d[e]){var c="function"==typeof require&&require;if(!b&&c)return c(e,!0);if(m)return m(e,!0);c=Error("Cannot find module '"+e+"'");throw c.code="MODULE_NOT_FOUND",
c;}c=f[e]={b:{}};d[e][0].call(c.b,function(a){var b=d[e][1][a];return k(b?b:a)},c,c.b,h,d,f,g)}return f[e].b}for(var m="function"==typeof require&&require,l=0;l<g.length;l++)k(g[l]);return k}({1:[function(h,d){var f=d.b=self.threads||{};f.client=h("../src/client");"u"!="undefined"[0]?(void 0)([],function(){return f}):self.threads=f},{"../src/client":2}],2:[function(h,d){function f(b,c){if(!(this instanceof f))return new f(b,c);this.id=l();this.M(c);this.D=b;this.c=new Set;this.i=m.i(this.id).f("_broadcast",
this.Z.bind(this));if(!this.endpoint)throw Error({1:"an endpoint must be defined"}[1]);}var g=h("./message/port-adaptors"),k=h("./emitter"),m=h("./message"),l=h("./utils").G;d.b=f;f.prototype={connect:function(){var b=this;if(this.j)return this.j;var c=new MessageChannel;this.channel=c.port1;this.channel.start();var a={K:this.id,D:this.D};return this.j=this.message("_connect").set("transfer",[c.port2]).set("data",a).h(c.port1).send().then(function(a){a.event.target===b.channel?b.M(b.channel):(b.channel.close(),
delete b.channel);b.i.h(b.endpoint)})},I:function(b){var c=this;if(!this.j)return Promise.resolve();b={l:b&&b.l,data:this.id};this.X();return this.message("_disconnect").set(b).send().then(function(){return c.$()})},S:function(b){var c=this,a=[].slice.call(arguments,1);return this.connect().then(function(){return c.message("_method","[Client]").set({v:c.D,data:{name:b,ma:a}}).send()}).then(function(a){return a.value})},ia:function(b){b(this,{message:m,ka:k,G:l});return this},message:function(b){var c=
this,a=m(b).set("endpoint",this.endpoint).f("response",function(){return c.c.delete(a)}).f("cancel",function(){return c.c.delete(a)});this.c.add(a);return a},X:function(){this.c.forEach(function(b){b.cancel()});this.c.clear()},ba:function(){var b=[];this.c.forEach(function(c){return b.push(c.O)});return Promise.all(b)},Z:function(b){this.U(b.data.type,b.data.data)},$:function(){var b=this;delete this.j;this.ba().then(function(){b.channel&&b.channel.close();b.g("disconnected")})},M:function(b){b&&
(this.endpoint=g(b));return this},u:function(){var b=this;return this.I().then(function(){b.Y||(b.Y=!0,b.i.u(),b.V())})},V:k.prototype.m,U:k.prototype.g};f.prototype.f=function(b,c){var a=this;this.connect().then(function(){k.prototype.f.call(a,b,c);a.message("_on").set("noRespond",!0).set("data",{name:b,K:a.id}).send(a.endpoint)});return this};f.prototype.m=function(b,c){var a=this;this.connect().then(function(){k.prototype.m.call(a,b,c);a.message("_off").set("noRespond",!0).set("data",{name:b,K:a.id}).send(a.endpoint)});
return this};var e=f.prototype;e.destroy=e.u;e.plugin=e.ia;e.method=e.S;e.connect=e.connect;e.disconnect=e.I;e.on=e.f;e.off=e.m},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":6}],3:[function(h,d){function f(k){if(k)return Object.assign(k,f.prototype)}d.b=f;f.prototype={f:function(k,d){this.a||(this.a={});this.a[k]||(this.a[k]=[]);this.a[k].push(d);return this},m:function(d,f){if(this.a)switch(arguments.length){case 0:this.a={};break;case 1:delete this.a[d];break;default:var g=
this.a[d];if(!g)return;var e=g.indexOf(f);~e&&g.splice(e,1)}return this},g:function(d,f){if(this.a)for(var g=this.a[d]||[],g=g.concat(this.a["*"]||[]),e=0;e<g.length;e++)g[e].call(this,f,d);return this}};var g=f.prototype;g.off=g.m;g.on=g.f},{}],4:[function(h,d,f){function g(a){this.J=!1;this.H=null;this.w=[];this.onMessage=this.onMessage.bind(this);this.A=this.A.bind(this);"object"===typeof a?this.fa(a):this.ga(a)}function k(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);
this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this)}function m(a){return Error({1:".send() can only be called once",2:"response already sent for this message"}[a])}var l=h("./port-adaptors"),e=h("../emitter");h=h("../utils");var b=h.L,c=h.G;f=d.b=function(a){return new g(a)};f.i=function(a){return new k(a)};f.j=k;f.c=g;g.prototype={timeout:1E3,ga:function(a){this.id=c();this.type=a;this.ca=!1;this.v="*"},fa:function(a){this.N=!1;this.ea(a.source||a.target);this.event=a;Object.assign(this,
a.data)},ea:function(a){this.source=l(a,{ready:!0});return this},set:function(a,b){"object"==typeof a?Object.assign(this,a):this[a]=b;return this},da:function(){return{id:this.id,type:this.type,data:this.data,v:this.v,l:this.l}},R:function(){this.defaultPrevented=!0},send:function(a){if(this.ca)throw m(1);var c=this.da(),d=!this.l;this.s=b();this.O=this.s.B;this.port=l(a||this.endpoint);d?(this.h(this.port),this.H=setTimeout(this.A,this.timeout)):this.s.resolve();this.port.postMessage(c,this.T());
return d?this.O:Promise.resolve()},T:function(){return this.ha||this.event&&this.event.ports},onMessage:function(a){a.data.response&&a.data.id===this.id&&!this.J&&this.aa(a)},A:function(){this.na||this.s.reject("no response");this.F()},h:function(a){a=l(a);a.addListener(this.onMessage);this.w.push(a);return this},o:function(){var a=this;this.w.forEach(function(b){return b.removeListener(a.onMessage)});this.w=[]},cancel:function(){this.F();this.J=!0;this.g("cancel")},F:function(){clearTimeout(this.H);
this.o()},C:function(a){function b(a){d({type:"resolve",value:a})}function c(a){d({type:"reject",value:a&&a.message||a})}function d(a){g.response=a;g.source.postMessage({id:g.id,response:a},g.ha)}if(this.N)throw m(2);if(this.source&&!this.l){var g=this;a instanceof Error&&c(a);Promise.resolve(a).then(b,c).catch(c);g.N=!0}},P:function(a){var b=this;return this.set("silentTimeout",!0).send(a).then(function(a){return b.C(a.value)})},aa:function(a){var b=this.s,c=a.data.response,d="reject"==c.type?c.value:
c;c.event=a;this.response=c;this.F();b[this.response.type](d);this.g("response",c)}};d=g.prototype;d.forward=d.P;d.respond=d.C;d.preventDefault=d.R;d.cancel=d.cancel;d.send=d.send;d.set=d.set;e(g.prototype);k.prototype={h:function(a){a=l(a||self,{i:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.h),this.ports.add(a),this},o:function(){var a=this;this.ports.forEach(function(b){b.removeListener(a.onMessage,a.o)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.W(a.data.v)&&
(a=new g(a),this.g("message",a),!a.defaultPrevented))try{this.g(a.type,a)}catch(b){throw a.C(b),b;}},W:function(a){return a==this.name||"*"==a||"*"==this.name},u:function(){this.o();delete this.name;return this}};d=k.prototype;d.listen=d.h;d.unlisten=d.o;d.destroy=d.u;e(k.prototype)},{"../emitter":3,"../utils":6,"./port-adaptors":5}],5:[function(h,d){function f(b){this.target=b}function g(b,c,a){b.addEventListener(c,a)}var k=h("../utils").L;d.b=function(b,c){if(b.addListener)return b;var a=l[b.constructor.name];
return a?a(b,c):new f(b)};var m=f.prototype={addListener:function(b){this.target.addEventListener("message",b)},removeListener:function(b){this.target.removeEventListener("message",b)},postMessage:function(b,c){this.target.postMessage(b,c)}},l={HTMLIFrameElement:function(b){var c=e(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(a,d){c.then(function(){b.contentWindow.postMessage(a,"*",
d)})}}},ja:function(b,c){function a(){var a=k();b.postMessage("ready?");g(b,"message",function p(c){"ready"==c.data&&(b.removeEventListener("message",p),a.resolve())});return a.B}var d=c&&c.i,e=c&&c.ready,e=e||d?Promise.resolve():a();d&&(b.postMessage("ready"),g(b,"message",function(a){"ready?"==a.data&&b.postMessage("ready")}));return{target:b,addListener:m.addListener,removeListener:m.removeListener,postMessage:function(a,c){e.then(function(){return b.postMessage(a,c)})}}},Window:function(b,c){var a=
c&&c.ready||b===self,a=a?Promise.resolve():e(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(c,d){a.then(function(){return b.postMessage(c,"*",d)})}}},SharedWorkerGlobalScope:function(){var b=[];return{postMessage:function(){},addListener:function(c,a){this.onconnect=function(c){c=c.ports[0];b.push(c);c.start();a(c)};self.addEventListener("connect",this.onconnect)},removeListener:function(c,
a){self.removeEventListener("connect",this.onconnect);b.forEach(function(b){b.close();a(b)})}}}},e=function(){if("undefined"!=typeof window){var b=window.opener||window.parent,c=new WeakSet;b!=self&&g(window,"DOMContentLoaded",function q(){window.removeEventListener("DOMContentLoaded",q);b.postMessage("load","*")});g(self,"message",function(b){return"load"==b.data&&c.add(b.source)});return function(b){var d=b.contentWindow||b;if(c.has(d)||d==window.parent)return Promise.resolve();var e=k();g(window,
"message",function p(b){"load"==b.data&&b.source==d&&(window.removeEventListener("message",p),e.resolve())});return e.B}}}()},{"../utils":6}],6:[function(h,d,f){f.G=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var f=16*Math.random()|0;return("x"==d?f:f&3|8).toString(16)})};f.L=function(){var d={};d.B=new Promise(function(f,h){d.resolve=f;d.reject=h});return d}},{}]},{},[1])(1)});
