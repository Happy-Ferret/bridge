(function(n){if("object"===typeof exports&&"undefined"!==typeof module)module.f=n();else if("function"===typeof define&&define.fa)define([],n);else{var h;"undefined"!==typeof window?h=window:"undefined"!==typeof global?h=global:"undefined"!==typeof self?h=self:h=this;h.ha=n()}})(function(){return function h(d,f,g){function k(e,b){if(!f[e]){if(!d[e]){var c="function"==typeof require&&require;if(!b&&c)return c(e,!0);if(m)return m(e,!0);c=Error("Cannot find module '"+e+"'");throw c.code="MODULE_NOT_FOUND",
c;}c=f[e]={f:{}};d[e][0].call(c.f,function(a){var b=d[e][1][a];return k(b?b:a)},c,c.f,h,d,f,g)}return f[e].f}for(var m="function"==typeof require&&require,l=0;l<g.length;l++)k(g[l]);return k}({1:[function(h,d){var f=d.f=self.threads||{};f.client=h("../src/client");"u"!="undefined"[0]?(void 0)([],function(){return f}):self.threads=f},{"../src/client":2}],2:[function(h,d){function f(b,c){if(!(this instanceof f))return new f(b,c);this.id=l();this.m(c);this.H=b;this.a=new Set;this.j=m.j(this.id).g("_broadcast",
this.V.bind(this));if(!this.endpoint)throw Error({1:"an endpoint must be defined"}[1]);}var g=h("./message/port-adaptors"),k=h("./emitter"),m=h("./message"),l=h("./utils").J;d.f=f;f.prototype={connect:function(){var b=this;if(this.c)return this.c;var c=new MessageChannel;this.channel=c.port1;this.channel.start();var a={K:this.id,H:this.H};return this.c=this.message("_connect").set("transfer",[c.port2]).set("data",a).i(c.port1).send().then(function(a){a.event.target===b.channel?b.m(b.channel):(b.channel.close(),
delete b.channel);b.j.i(b.endpoint)})},l:function(b){var c=this;if(!this.c)return Promise.resolve();b={o:b&&b.o,data:this.id};this.M();return this.message("_disconnect").set(b).send().then(function(){return c.W()})},w:function(b){var c=this,a=[].slice.call(arguments,1);return this.connect().then(function(){return c.message("_method","[Client]").set({A:c.H,data:{name:b,ga:a}}).send()}).then(function(a){return a.value})},ca:function(b){b(this,{message:m,ea:k,J:l});return this},message:function(b){var c=
this,a=m(b).set("endpoint",this.endpoint).g("response",function(){return c.a.delete(a)}).g("cancel",function(){return c.a.delete(a)});this.a.add(a);return a},M:function(){this.a.forEach(function(b){b.cancel()});this.a.clear()},Y:function(){var b=[];this.a.forEach(function(c){return b.push(c.N)});return Promise.all(b)},V:function(b){this.B(b.data.type,b.data.data)},W:function(){var b=this;delete this.c;this.Y().then(function(){b.channel&&b.channel.close();b.h("disconnected")})},m:function(b){b&&(this.endpoint=
g(b));return this},v:function(){var b=this;return this.l().then(function(){b.U||(b.U=!0,b.j.v(),b.C())})},C:k.prototype.s,B:k.prototype.h};f.prototype.g=function(b,c){var a=this;this.connect().then(function(){k.prototype.g.call(a,b,c);a.message("_on").set("noRespond",!0).set("data",{name:b,K:a.id}).send(a.endpoint)});return this};f.prototype.s=function(b,c){var a=this;this.connect().then(function(){k.prototype.s.call(a,b,c);a.message("_off").set("noRespond",!0).set("data",{name:b,K:a.id}).send(a.endpoint)});
return this};var e=f.prototype;e.destroy=e.v;e.plugin=e.ca;e.method=e.w;e.connect=e.connect;e.disconnect=e.l;e.on=e.g;e.off=e.s},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":6}],3:[function(h,d){function f(k){if(k)return Object.assign(k,f.prototype)}d.f=f;f.prototype={g:function(k,d){this.b||(this.b={});this.b[k]||(this.b[k]=[]);this.b[k].push(d);return this},s:function(d,f){if(this.b)switch(arguments.length){case 0:this.b={};break;case 1:delete this.b[d];break;default:var g=
this.b[d];if(!g)return;var e=g.indexOf(f);~e&&g.splice(e,1)}return this},h:function(d,f){if(this.b)for(var g=this.b[d]||[],g=g.concat(this.b["*"]||[]),e=0;e<g.length;e++)g[e].call(this,f,d);return this}};var g=f.prototype;g.off=g.s;g.on=g.g},{}],4:[function(h,d,f){function g(a){this.m=!1;this.l=null;this.c=[];this.onMessage=this.onMessage.bind(this);this.D=this.D.bind(this);"object"===typeof a?this.aa(a):this.ba(a)}function k(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);
this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this)}function m(a){return Error({1:".send() can only be called once",2:"response already sent for this message"}[a])}var l=h("./port-adaptors"),e=h("../emitter");h=h("../utils");var b=h.L,c=h.J;f=d.f=function(a){return new g(a)};f.j=function(a){return new k(a)};f.c=k;f.a=g;g.prototype={R:1E3,ba:function(a){this.id=c();this.type=a;this.B=!1;this.A="*"},aa:function(a){this.w=!1;this.$(a.source||a.target);this.event=a;Object.assign(this,
a.data)},$:function(a){this.source=l(a,{ready:!0});return this},set:function(a,b){"object"==typeof a?Object.assign(this,a):this[a]=b;return this},Z:function(){return{id:this.id,type:this.type,data:this.data,A:this.A,o:this.o}},P:function(){this.defaultPrevented=!0},send:function(a){if(this.B)throw m(1);var c=this.Z(),d=!this.o;this.a=b();this.N=this.a.F;this.port=l(a||this.endpoint);d?(this.i(this.port),this.l=setTimeout(this.D,this.R)):this.a.resolve();this.port.postMessage(c,this.S());return d?
this.N:Promise.resolve()},S:function(){return this.C||this.event&&this.event.ports},onMessage:function(a){a.data.response&&a.data.id===this.id&&!this.m&&this.X(a)},D:function(){this.M||this.a.reject("no response");this.I()},i:function(a){a=l(a);a.addListener(this.onMessage);this.c.push(a);return this},u:function(){var a=this;this.c.forEach(function(b){return b.removeListener(a.onMessage)});this.c=[]},cancel:function(){this.I();this.m=!0;this.h("cancel")},I:function(){clearTimeout(this.l);this.u()},
G:function(a){function b(a){d({type:"resolve",value:a})}function c(a){d({type:"reject",value:a.message||a})}function d(a){g.response=a;g.source.postMessage({id:g.id,response:a},g.C)}if(this.w)throw m(2);if(this.source&&!this.o){var g=this;a instanceof Error&&c(a);Promise.resolve(a).then(b,c).catch(c);g.w=!0}},O:function(a){var b=this;return this.set("silentTimeout",!0).send(a).then(function(a){return b.G(a.value)})},X:function(a){var b=this.a,c=a.data.response,d="reject"==c.type?c.value:c;c.event=
a;this.response=c;this.I();b[this.response.type](d);this.h("response",c)}};d=g.prototype;d.forward=d.O;d.respond=d.G;d.preventDefault=d.P;d.cancel=d.cancel;d.send=d.send;d.set=d.set;e(g.prototype);k.prototype={i:function(a){a=l(a||self,{j:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.i),this.ports.add(a),this},u:function(){var a=this;this.ports.forEach(function(b){b.removeListener(a.onMessage,a.u)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.T(a.data.A)&&(a=new g(a),
this.h("message",a),!a.defaultPrevented))try{this.h(a.type,a)}catch(b){throw a.G(b),b;}},T:function(a){return a==this.name||"*"==a||"*"==this.name},v:function(){this.u();delete this.name;return this}};d=k.prototype;d.listen=d.i;d.unlisten=d.u;d.destroy=d.v;e(k.prototype)},{"../emitter":3,"../utils":6,"./port-adaptors":5}],5:[function(h,d){function f(b){this.target=b}function g(b,c,a){b.addEventListener(c,a)}var k=h("../utils").L;d.f=function(b,c){if(b.addListener)return b;var a=l[b.constructor.name];
return a?a(b,c):new f(b)};var m=f.prototype={addListener:function(b){this.target.addEventListener("message",b)},removeListener:function(b){this.target.removeEventListener("message",b)},postMessage:function(b,c){this.target.postMessage(b,c)}},l={HTMLIFrameElement:function(b){var c=e(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(a,d){c.then(function(){b.contentWindow.postMessage(a,"*",
d)})}}},da:function(b,c){function a(){var a=k();b.postMessage("ready?");g(b,"message",function p(c){"ready"==c.data&&(b.removeEventListener("message",p),a.resolve())});return a.F}var d=c&&c.j,e=c&&c.ready,e=e||d?Promise.resolve():a();d&&(b.postMessage("ready"),g(b,"message",function(a){"ready?"==a.data&&b.postMessage("ready")}));return{target:b,addListener:m.addListener,removeListener:m.removeListener,postMessage:function(a,c){e.then(function(){return b.postMessage(a,c)})}}},Window:function(b,c){var a=
c&&c.ready||b===self,a=a?Promise.resolve():e(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(c,d){a.then(function(){return b.postMessage(c,"*",d)})}}},SharedWorkerGlobalScope:function(){var b=[];return{postMessage:function(){},addListener:function(c,a){this.onconnect=function(c){c=c.ports[0];b.push(c);c.start();a(c)};self.addEventListener("connect",this.onconnect)},removeListener:function(c,
a){self.removeEventListener("connect",this.onconnect);b.forEach(function(b){b.close();a(b)})}}}},e=function(){if("undefined"!=typeof window){var b=window.opener||window.parent,c=new WeakSet;b!=self&&g(window,"DOMContentLoaded",function q(){window.removeEventListener("DOMContentLoaded",q);b.postMessage("load","*")});g(self,"message",function(b){return"load"==b.data&&c.add(b.source)});return function(b){var d=b.contentWindow||b;if(c.has(d)||d==window.parent)return Promise.resolve();var e=k();g(window,
"message",function p(b){"load"==b.data&&b.source==d&&(window.removeEventListener("message",p),e.resolve())});return e.F}}}()},{"../utils":6}],6:[function(h,d,f){f.J=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var f=16*Math.random()|0;return("x"==d?f:f&3|8).toString(16)})};f.L=function(){var d={};d.F=new Promise(function(f,h){d.resolve=f;d.reject=h});return d}},{}]},{},[1])(1)});
