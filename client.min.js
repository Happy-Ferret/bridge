(function(n){if("object"===typeof exports&&"undefined"!==typeof module)module.b=n();else if("function"===typeof define&&define.ka)define([],n);else{var h;"undefined"!==typeof window?h=window:"undefined"!==typeof global?h=global:"undefined"!==typeof self?h=self:h=this;h.oa=n()}})(function(){return function h(d,e,f){function k(g,b){if(!e[g]){if(!d[g]){var c="function"==typeof require&&require;if(!b&&c)return c(g,!0);if(m)return m(g,!0);c=Error("Cannot find module '"+g+"'");throw c.code="MODULE_NOT_FOUND",
c;}c=e[g]={b:{}};d[g][0].call(c.b,function(a){var b=d[g][1][a];return k(b?b:a)},c,c.b,h,d,e,f)}return e[g].b}for(var m="function"==typeof require&&require,l=0;l<f.length;l++)k(f[l]);return k}({1:[function(h,d){var e=d.b=self.threads||{};e.client=h("../src/client");"u"!="undefined"[0]?(void 0)([],function(){return e}):self.threads=e},{"../src/client":2}],2:[function(h,d){function e(b,c){if(!(this instanceof e))return new e(b,c);this.id=l();this.F=b;this.j=c||this.j;if(!this.j)throw Error({1:"an endpoint must be defined"}[1]);
this.M(this.j);this.c=new Set;this.h=m.h(this.id).g("_push",this.aa.bind(this))}var f=h("./message/port-adaptors"),k=h("./emitter"),m=h("./message"),l=h("./utils").P;d.b=e;e.prototype={connect:function(){var b=this;if(this.u)return this.u;var c=new MessageChannel;this.channel=c.port1;this.channel.start();var a={J:this.id,F:this.F};return this.u=this.message("_connect").set("transfer",[c.port2]).set("data",a).i(c.port1).send().then(function(a){a.event.target===b.channel?b.M(b.channel):(b.channel.close(),
delete b.channel);b.h.i(b.port)})},K:function(b){var c=this;if(!this.u)return Promise.resolve();b={m:b&&b.m,data:this.id};this.X();return this.message("_disconnect").set(b).send().then(function(){return c.Z()})},U:function(b){var c=this,a=[].slice.call(arguments,1);return this.connect().then(function(){return c.message("_method","[Client]").set({w:c.F,data:{name:b,la:a}}).send()}).then(function(a){return a.value})},ia:function(b){b(this,{Emitter:k,uuid:l});return this},message:function(b){var c=this,
a=m(b).set("port",this.port).g("response",function(){return c.c.delete(a)}).g("cancel",function(){return c.c.delete(a)});this.c.add(a);return a},X:function(){this.c.forEach(function(b){b.cancel()});this.c.clear()},ha:function(){var b=[];this.c.forEach(function(c){return b.push(c.ma)});return Promise.all(b)},aa:function(b){this.L(b.data.type,b.data.data)},Z:function(){var b=this;delete this.u;this.ha().then(function(){b.channel&&b.channel.close();b.L("disconnected")})},M:function(b){this.port=f(b)},
v:function(){var b=this;return this.K().then(function(){b.Y||(b.Y=!0,b.h.v(),b.W(),b.port=b.j=b.h=null)})},W:k.prototype.o,L:k.prototype.l};e.prototype.g=function(b,c){var a=this;this.connect().then(function(){k.prototype.g.call(a,b,c);a.message("_on").set("noRespond",!0).set("data",{name:b,J:a.id}).send(a.port)});return this};e.prototype.o=function(b,c){var a=this;this.connect().then(function(){k.prototype.o.call(a,b,c);a.message("_off").set("noRespond",!0).set("data",{name:b,J:a.id}).send(a.port)});
return this};var g=e.prototype;g.destroy=g.v;g.plugin=g.ia;g.method=g.U;g.connect=g.connect;g.disconnect=g.K;g.on=g.g;g.off=g.o},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":6}],3:[function(h,d){function e(k){if(k)return Object.assign(k,e.prototype)}d.b=e;e.prototype={g:function(k,d){this.a||(this.a={});this.a[k]||(this.a[k]=[]);this.a[k].push(d);return this},o:function(d,e){if(this.a)switch(arguments.length){case 0:this.a={};break;case 1:delete this.a[d];break;default:var f=
this.a[d];if(!f)return;var g=f.indexOf(e);~g&&f.splice(g,1)}return this},l:function(d,e){if(this.a)for(var f=this.a[d]||[],f=f.concat(this.a["*"]||[]),g=0;g<f.length;g++)f[g].call(this,e,d);return this}};var f=e.prototype;f.off=f.o;f.on=f.g},{}],4:[function(h,d,e){function f(a){this.I=!1;this.H=null;this.A=[];this.f=b();this.onMessage=this.onMessage.bind(this);this.B=this.B.bind(this);"object"===typeof a?this.ea(a):this.fa(a)}function k(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);
this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this)}function m(a){return Error({1:".send() can only be called once",2:"response already sent for this message",3:"a port must be defined"}[a])}var l=h("./port-adaptors"),g=h("../emitter");h=h("../utils");var b=h.f,c=h.P;e=d.b=function(a){return new f(a)};e.h=function(a){return new k(a)};e.j=k;e.c=f;f.prototype={timeout:1E3,fa:function(a){this.id=c();this.type=a;this.ba=!1;this.w="*"},ea:function(a){this.N=!1;this.da(a.source||a.target);
this.event=a;Object.assign(this,a.data)},da:function(a){this.O=l(a,{ready:!0});return this},set:function(a,b){"object"==typeof a?Object.assign(this,a):this[a]=b;return this},ca:function(){return{id:this.id,type:this.type,data:this.data,w:this.w,m:this.m}},S:function(){this.defaultPrevented=!0},send:function(a){if(this.ba)throw m(1);var b=this.ca(),c=!this.m;this.port=a?l(a):this.port;if(!this.port)throw m(3);c?(this.i(this.port),this.H=setTimeout(this.B,this.timeout)):this.f.resolve();this.port.postMessage(b,
this.T());return this.f.C},T:function(){return this.ga||this.event&&this.event.ports},onMessage:function(a){a.data.response&&a.data.id===this.id&&!this.I&&this.$(a)},B:function(){this.na||this.f.reject("no response");this.G()},i:function(a){a=l(a);a.addListener(this.onMessage);this.A.push(a);return this},s:function(){var a=this;this.A.forEach(function(b){return b.removeListener(a.onMessage)});this.A=[]},cancel:function(){this.G();this.I=!0;this.l("cancel")},G:function(){clearTimeout(this.H);this.s()},
D:function(a){function b(a){d({type:"resolve",value:a})}function c(a){d({type:"reject",value:a&&a.message||a})}function d(a){f.response=a;f.O.postMessage({id:f.id,response:a},f.ga)}if(this.N)throw m(2);if(this.O&&!this.m){var f=this;this.N=!0;a instanceof Error&&c(a);Promise.resolve(a).then(b,c).catch(c)}},R:function(a){var b=this;return this.set("silentTimeout",!0).send(a).then(function(a){return b.D(a.value)})},$:function(a){var b=a.data.response,c="reject"==b.type?b.value:b;b.event=a;this.response=
b;this.G();this.f[this.response.type](c);this.l("response",b)}};d=f.prototype;d.forward=d.R;d.respond=d.D;d.preventDefault=d.S;d.cancel=d.cancel;d.send=d.send;d.set=d.set;g(f.prototype);k.prototype={i:function(a){a=l(a||self,{h:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.i),this.ports.add(a),this},s:function(){var a=this;this.ports.forEach(function(b){b.removeListener(a.onMessage,a.s)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.V(a.data.w)&&(a=new f(a),this.l("message",
a),!a.defaultPrevented))try{this.l(a.type,a)}catch(b){throw a.D(b),b;}},V:function(a){return a==this.name||"*"==a||"*"==this.name},v:function(){this.s();delete this.name;return this}};d=k.prototype;d.listen=d.i;d.unlisten=d.s;d.destroy=d.v;g(k.prototype)},{"../emitter":3,"../utils":6,"./port-adaptors":5}],5:[function(h,d){function e(b){this.target=b}function f(b,c,a){b.addEventListener(c,a)}var k=h("../utils").f;d.b=function(b,c){if(!b)throw Error({1:"target is undefined"}[1]);if(b&&b.addListener)return b;
var a=l[b.constructor.name];return a?a(b,c):new e(b)};var m=e.prototype={constructor:e,addListener:function(b){this.target.addEventListener("message",b)},removeListener:function(b){this.target.removeEventListener("message",b)},postMessage:function(b,c){this.target.postMessage(b,c)}},l={HTMLIFrameElement:function(b){var c=g(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(a,d){c.then(function(){b.contentWindow.postMessage(a,
"*",d)})}}},ja:function(b,c){function a(){var a=k();b.postMessage("ready?");f(b,"message",function p(c){"ready"==c.data&&(b.removeEventListener("message",p),a.resolve())});return a.C}var d=c&&c.h,e=c&&c.ready,e=e||d?Promise.resolve():a();d&&(b.postMessage("ready"),f(b,"message",function(a){"ready?"==a.data&&b.postMessage("ready")}));return{target:b,addListener:m.addListener,removeListener:m.removeListener,postMessage:function(a,c){e.then(function(){return b.postMessage(a,c)})}}},Window:function(b,
c){var a=c&&c.ready||b===self,a=a?Promise.resolve():g(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(c,d){a.then(function(){return b.postMessage(c,"*",d)})}}},SharedWorkerGlobalScope:function(){var b=[];return{postMessage:function(){},addListener:function(c,a){this.onconnect=function(c){c=c.ports[0];b.push(c);c.start();a(c)};self.addEventListener("connect",this.onconnect)},removeListener:function(c,
a){self.removeEventListener("connect",this.onconnect);b.forEach(function(b){b.close();a(b)})}}}},g=function(){if("undefined"!=typeof window){var b=window.opener||window.parent,c=new WeakSet;b!=self&&f(window,"DOMContentLoaded",function q(){window.removeEventListener("DOMContentLoaded",q);b.postMessage("load","*")});f(self,"message",function(b){return"load"==b.data&&c.add(b.source)});return function(b){var d=b.contentWindow||b;if(c.has(d)||d==window.parent)return Promise.resolve();var e=k();f(window,
"message",function p(b){"load"==b.data&&b.source==d&&(window.removeEventListener("message",p),e.resolve())});return e.C}}}()},{"../utils":6}],6:[function(h,d,e){e.P=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var e=16*Math.random()|0;return("x"==d?e:e&3|8).toString(16)})};e.f=function(){var d={};d.C=new Promise(function(e,h){d.resolve=e;d.reject=h});return d}},{}]},{},[1])(1)});
