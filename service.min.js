(function(n){if("object"===typeof exports&&"undefined"!==typeof module)module.c=n();else if("function"===typeof define&&define.ha)define([],n);else{var e;"undefined"!==typeof window?e=window:"undefined"!==typeof global?e=global:"undefined"!==typeof self?e=self:e=this;e.ma=n()}})(function(){return function e(d,b,f){function k(a,h){if(!b[a]){if(!d[a]){var m="function"==typeof require&&require;if(!h&&m)return m(a,!0);if(l)return l(a,!0);m=Error("Cannot find module '"+a+"'");throw m.code="MODULE_NOT_FOUND",
m;}m=b[a]={c:{}};d[a][0].call(m.c,function(c){var h=d[a][1][c];return k(h?h:c)},m,m.c,e,d,b,f)}return b[a].c}for(var l="function"==typeof require&&require,g=0;g<f.length;g++)k(f[g]);return k}({1:[function(e,d){var b=d.c=self.threads||{};b.service=e("../src/service");"u"!="undefined"[0]?(void 0)([],function(){return b}):self.threads=b},{"../src/service":5}],2:[function(e,d){function b(d){if(d)return Object.assign(d,b.prototype)}d.c=b;b.prototype={f:function(b,d){this.a||(this.a={});this.a[b]||(this.a[b]=
[]);this.a[b].push(d);return this},H:function(b,d){if(this.a)switch(arguments.length){case 0:this.a={};break;case 1:delete this.a[b];break;default:var f=this.a[b];if(!f)return;var a=f.indexOf(d);~a&&f.splice(a,1)}return this},b:function(b,d){if(this.a)for(var f=this.a[b]||[],f=f.concat(this.a["*"]||[]),a=0;a<f.length;a++)f[a].call(this,d,b);return this}};var f=b.prototype;f.off=f.H;f.on=f.f},{}],3:[function(e,d,b){function f(c){this.D=!1;this.C=null;this.s=[];this.onMessage=this.onMessage.bind(this);
this.u=this.u.bind(this);"object"===typeof c?this.ca(c):this.da(c)}function k(c){this.name=c;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this)}function l(c){return Error({1:".send() can only be called once",2:"response already sent for this message"}[c])}var g=e("./port-adaptors"),a=e("../emitter");e=e("../utils");var h=e.F,m=e.A;b=d.c=function(c){return new f(c)};b.I=function(c){return new k(c)};b.B=k;b.ga=f;f.prototype=
{timeout:1E3,da:function(c){this.id=m();this.type=c;this.aa=!1;this.m="*"},ca:function(c){this.G=!1;this.K(c.source||c.target);this.event=c;Object.assign(this,c.data)},K:function(c){this.source=g(c,{ready:!0});return this},set:function(c,h){"object"==typeof c?Object.assign(this,c):this[c]=h;return this},ba:function(){return{id:this.id,type:this.type,data:this.data,m:this.m,l:this.l}},N:function(){this.defaultPrevented=!0},send:function(c){if(this.aa)throw l(1);var a=this.ba(),b=!this.l;this.o=h();
this.$=this.o.v;this.port=g(c||this.endpoint);b?(this.j(this.port),this.C=setTimeout(this.u,this.timeout)):this.o.resolve();this.port.postMessage(a,this.S());return b?this.$:Promise.resolve()},S:function(){return this.ea||this.event&&this.event.ports},onMessage:function(c){c.data.response&&c.data.id===this.id&&!this.D&&this.Y(c)},u:function(){this.la||this.o.reject("no response");this.w()},j:function(c){c=g(c);c.addListener(this.onMessage);this.s.push(c);return this},h:function(){var c=this;this.s.forEach(function(h){return h.removeListener(c.onMessage)});
this.s=[]},L:function(){this.w();this.D=!0;this.b("cancel")},w:function(){clearTimeout(this.C);this.h()},g:function(c){function h(c){b({type:"resolve",value:c})}function a(c){b({type:"reject",value:c&&c.message||c})}function b(c){d.response=c;d.source.postMessage({id:d.id,response:c},d.ea)}if(this.G)throw l(2);if(this.source&&!this.l){var d=this;c instanceof Error&&a(c);Promise.resolve(c).then(h,a).catch(a);d.G=!0}},M:function(c){var h=this;return this.set("silentTimeout",!0).send(c).then(function(c){return h.g(c.value)})},
Y:function(c){var h=this.o,a=c.data.response,b="reject"==a.type?a.value:a;a.event=c;this.response=a;this.w();h[this.response.type](b);this.b("response",a)}};d=f.prototype;d.forward=d.M;d.respond=d.g;d.preventDefault=d.N;d.cancel=d.L;d.send=d.send;d.set=d.set;a(f.prototype);k.prototype={j:function(c){c=g(c||self,{I:!0});if(!this.ports.has(c))return c.addListener(this.onMessage,this.j),this.ports.add(c),this},h:function(){var c=this;this.ports.forEach(function(a){a.removeListener(c.onMessage,c.h)})},
onMessage:function(c){if(c.data.id&&c.data.type&&this.T(c.data.m)&&(c=new f(c),this.b("message",c),!c.defaultPrevented))try{this.b(c.type,c)}catch(a){throw c.g(a),a;}},T:function(c){return c==this.name||"*"==c||"*"==this.name},i:function(){this.h();delete this.name;return this}};d=k.prototype;d.listen=d.j;d.unlisten=d.h;d.destroy=d.i;a(k.prototype)},{"../emitter":2,"../utils":6,"./port-adaptors":4}],4:[function(e,d){function b(a){this.target=a}function f(a,b,c){a.addEventListener(b,c)}var k=e("../utils").F;
d.c=function(a,d){if(a.addListener)return a;var c=g[a.constructor.name];return c?c(a,d):new b(a)};var l=b.prototype={addListener:function(a){this.target.addEventListener("message",a)},removeListener:function(a){this.target.removeEventListener("message",a)},postMessage:function(a,b){this.target.postMessage(a,b)}},g={HTMLIFrameElement:function(b){var d=a(b);return{addListener:function(c){window.addEventListener("message",c)},removeListener:function(c){window.removeEventListener("message",c)},postMessage:function(c,
a){d.then(function(){b.contentWindow.postMessage(c,"*",a)})}}},fa:function(a,b){function c(){var c=k();a.postMessage("ready?");f(a,"message",function p(b){"ready"==b.data&&(a.removeEventListener("message",p),c.resolve())});return c.v}var d=b&&b.I,e=b&&b.ready,e=e||d?Promise.resolve():c();d&&(a.postMessage("ready"),f(a,"message",function(c){"ready?"==c.data&&a.postMessage("ready")}));return{target:a,addListener:l.addListener,removeListener:l.removeListener,postMessage:function(c,b){e.then(function(){return a.postMessage(c,
b)})}}},Window:function(b,d){var c=d&&d.ready||b===self,c=c?Promise.resolve():a(b);return{addListener:function(c){window.addEventListener("message",c)},removeListener:function(c){window.removeEventListener("message",c)},postMessage:function(a,d){c.then(function(){return b.postMessage(a,"*",d)})}}},SharedWorkerGlobalScope:function(){var a=[];return{postMessage:function(){},addListener:function(b,c){this.onconnect=function(b){b=b.ports[0];a.push(b);b.start();c(b)};self.addEventListener("connect",this.onconnect)},
removeListener:function(b,c){self.removeEventListener("connect",this.onconnect);a.forEach(function(a){a.close();c(a)})}}}},a=function(){if("undefined"!=typeof window){var a=window.opener||window.parent,b=new WeakSet;a!=self&&f(window,"DOMContentLoaded",function q(){window.removeEventListener("DOMContentLoaded",q);a.postMessage("load","*")});f(self,"message",function(a){return"load"==a.data&&b.add(a.source)});return function(a){var d=a.contentWindow||a;if(b.has(d)||d==window.parent)return Promise.resolve();
var h=k();f(window,"message",function p(a){"load"==a.data&&a.source==d&&(window.removeEventListener("message",p),h.resolve())});return h.v}}}()},{"../utils":6}],5:[function(e,d){function b(a){if(!(this instanceof b))return new b(a);l.B.call(this,a);this.clients={};this.methods={};this.f("_disconnect",this.onDisconnect.bind(this)).f("_connect",this.U.bind(this)).f("_method",this.V.bind(this)).f("_off",this.W.bind(this)).f("_on",this.X.bind(this));this.i=this.i.bind(this)}function f(a){return Error({4:'method "'+
[].slice.call(arguments,1)[0]+"\" doesn't exist"}[a])}var k=e("./utils").A,l=e("./message"),g=l.B;d.c=b;b.prototype=Object.create(g.prototype);b.prototype.method=function(a,b){this.methods[a]=b;return this};b.prototype.P=function(a,b,d){var c={type:a,data:b};this.R(function(a){d&&!~d.indexOf(a.id)||l("_broadcast").set({m:a.id,l:!0,data:c}).send(a.endpoint)});return this};b.prototype.R=function(a){for(var b in this.clients)a(this.clients[b])};b.prototype.U=function(a){var b=a.data,d=b.ja;if(d&&b.ka===
this.name&&!this.clients[d]&&(this.b("before-connect",a),!a.defaultPrevented)){if(b=(b=a.event.ports)&&b[0])a.K(b),this.j(b),b.start();this.O(d,a.source);a.g();this.b("connected",d)}};b.prototype.onDisconnect=function(a){var b=this.clients[a.data];b&&(this.b("before-disconnect",a),a.defaultPrevented||(this.J(b.id),a.g(),this.b("disconnected",b.id)))};b.prototype.V=function(a){this.b("before-method",a);if(!a.defaultPrevented){var b=a.data,d=b.name,c,e=this.methods[d];if(!e)throw f(4,d);try{c=e.apply(this,
b.ia)}catch(g){c=g}a.g(c)}};b.prototype.X=function(a){this.b("on",a.data)};b.prototype.W=function(a){this.b("off",a.data)};b.prototype.O=function(a,b){this.clients[a]={id:a,endpoint:b}};b.prototype.J=function(a){delete this.clients[a]};b.prototype.Z=function(a){a(this,{message:l,A:k});return this};b.prototype.disconnect=function(a){this.J(a.id);l("disconnect").set({m:a.id,l:!0}).send(a.endpoint)};b.prototype.i=function(){delete this.clients;this.h();this.H()};g=b.prototype;g.broadcast=g.P;g.destroy=
g.i;g.method=g.method;g.plugin=g.Z},{"./message":3,"./utils":6}],6:[function(e,d,b){b.A=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var d=16*Math.random()|0;return("x"==b?d:d&3|8).toString(16)})};b.F=function(){var b={};b.v=new Promise(function(d,e){b.resolve=d;b.reject=e});return b}},{}]},{},[1])(1)});
