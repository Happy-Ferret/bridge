(function p(e,d,g){function k(a,b){if(!d[a]){if(!e[a]){var m="function"==typeof require&&require;if(!b&&m)return m(a,!0);if(l)return l(a,!0);m=Error("Cannot find module '"+a+"'");throw m.code="MODULE_NOT_FOUND",m;}m=d[a]={i:{}};e[a][0].call(m.i,function(c){var b=e[a][1][c];return k(b?b:c)},m,m.i,p,e,d,g)}return d[a].i}for(var l="function"==typeof require&&require,f=0;f<g.length;f++)k(g[f]);return k})({1:[function(h){var e={service:h("../src/service"),client:h("../src/client"),na:h("../src/message")};
"u"!=(typeof define)[0]?define([],function(){return e}):self.threads=e},{"../src/client":2,"../src/message":4,"../src/service":6}],2:[function(h,e){function d(b,a){if(!(this instanceof d))return new d(b,a);this.id=f();this.w(a);this.D=b;this.b=new Set;this.o=l.o(this.id).c("_broadcast",this.O.bind(this));if(!this.endpoint)throw Error({1:"an endpoint must be defined"}[1]);}var g=h("./message/port-adaptors"),k=h("./emitter"),l=h("./message"),f=h("./utils").A;e.i=d;d.prototype={connect:function(){var b=
this;if(this.g)return this.g;var a=new MessageChannel;this.channel=a.port1;this.channel.start();var c={F:this.id,D:this.D};return this.g=this.message("_connect").set("transfer",[a.port2]).set("data",c).j(a.port1).send().then(function(c){c.event.target===b.channel?b.w(b.channel):(b.channel.close(),delete b.channel);b.o.j(b.endpoint)})},disconnect:function(b){var a=this;if(!this.g)return Promise.resolve();b={l:b&&b.l,data:this.id};this.G();return this.message("_disconnect").set(b).send().then(function(){return a.ba()})},
method:function(b){var a=this,c=[].slice.call(arguments,1);return this.connect().then(function(){return a.message("_method","[Client]").set({s:a.D,data:{name:b,X:c}}).send()}).then(function(c){return c.value})},J:function(b){b(this,{message:l,ma:k,A:f});return this},message:function(b){var a=this,c=l(b).set("endpoint",this.endpoint).c("response",function(){return a.b.delete(c)}).c("cancel",function(){return a.b.delete(c)});this.b.add(c);return c},G:function(){this.b.forEach(function(b){b.cancel()});
this.b.clear()},ca:function(){var b=[];this.b.forEach(function(a){return b.push(a.R)});return Promise.all(b)},O:function(b){this.B(b.data.type,b.data.data)},ba:function(){var b=this;delete this.g;this.ca().then(function(){b.channel&&b.channel.close();b.a("disconnected")})},w:function(b){b&&(this.endpoint=g(b));return this},h:function(){var b=this;return this.disconnect().then(function(){b.H||(b.H=!0,b.o.h(),b.C())})},C:k.prototype.m,B:k.prototype.a};d.prototype.c=function(b,a){var c=this;this.connect().then(function(){k.prototype.c.call(c,
b,a);c.message("_on").set("noRespond",!0).set("data",{name:b,F:c.id}).send(c.endpoint)});return this};d.prototype.m=function(b,a){var c=this;this.connect().then(function(){k.prototype.m.call(c,b,a);c.message("_off").set("noRespond",!0).set("data",{name:b,F:c.id}).send(c.endpoint)});return this};var a=d.prototype;a.destroy=a.h;a.plugin=a.J;a.method=a.method;a.connect=a.connect;a.disconnect=a.disconnect;a.on=a.c;a.off=a.m},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":7}],3:[function(h,
e){function d(e){if(e)return Object.assign(e,d.prototype)}e.i=d;d.prototype={c:function(d,e){this.f||(this.f={});this.f[d]||(this.f[d]=[]);this.f[d].push(e);return this},m:function(d,e){if(this.f)switch(arguments.length){case 0:this.f={};break;case 1:delete this.f[d];break;default:var f=this.f[d];if(!f)return;var a=f.indexOf(e);~a&&f.splice(a,1)}return this},a:function(d,e){if(this.f)for(var f=this.f[d]||[],f=f.concat(this.f["*"]||[]),a=0;a<f.length;a++)f[a].call(this,e,d);return this}};var g=d.prototype;
g.off=g.m;g.on=g.c},{}],4:[function(h,e,d){function g(c){this.B=!1;this.w=null;this.g=[];this.onMessage=this.onMessage.bind(this);this.I=this.I.bind(this);"object"===typeof c?this.ja(c):this.ka(c)}function k(c){this.name=c;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this)}function l(c){return Error({1:".send() can only be called once",2:"response already sent for this message"}[c])}var f=h("./port-adaptors"),a=h("../emitter");
h=h("../utils");var b=h.N,m=h.A;d=e.i=function(c){return new g(c)};d.o=function(c){return new k(c)};d.M=k;d.b=g;g.prototype={V:1E3,ka:function(c){this.id=m();this.type=c;this.G=!1;this.s="*"},ja:function(c){this.C=!1;this.S(c.source||c.target);this.event=c;Object.assign(this,c.data)},S:function(c){this.source=f(c,{ready:!0});return this},set:function(c,b){"object"==typeof c?Object.assign(this,c):this[c]=b;return this},ia:function(){return{id:this.id,type:this.type,data:this.data,s:this.s,l:this.l}},
U:function(){this.defaultPrevented=!0},send:function(c){if(this.G)throw l(1);var a=this.ia(),d=!this.l;this.b=b();this.R=this.b.K;this.port=f(c||this.endpoint);d?(this.j(this.port),this.w=setTimeout(this.I,this.V)):this.b.resolve();this.port.postMessage(a,this.$());return d?this.R:Promise.resolve()},$:function(){return this.H||this.event&&this.event.ports},onMessage:function(c){c.data.response&&c.data.id===this.id&&!this.B&&this.ha(c)},I:function(){this.O||this.b.reject("no response");this.L()},j:function(c){c=
f(c);c.addListener(this.onMessage);this.g.push(c);return this},v:function(){var c=this;this.g.forEach(function(b){return b.removeListener(c.onMessage)});this.g=[]},cancel:function(){this.L();this.B=!0;this.a("cancel")},L:function(){clearTimeout(this.w);this.v()},u:function(c){function b(c){d({type:"resolve",value:c})}function a(c){d({type:"reject",value:c.message||c})}function d(c){e.response=c;e.source.postMessage({id:e.id,response:c},e.H)}if(this.C)throw l(2);if(this.source&&!this.l){var e=this;
c instanceof Error&&a(c);Promise.resolve(c).then(b,a).catch(a);e.C=!0}},T:function(c){var b=this;return this.set("silentTimeout",!0).send(c).then(function(c){return b.u(c.value)})},ha:function(c){var b=this.b,a=c.data.response,d="reject"==a.type?a.value:a;a.event=c;this.response=a;this.L();b[this.response.type](d);this.a("response",a)}};e=g.prototype;e.forward=e.T;e.respond=e.u;e.preventDefault=e.U;e.cancel=e.cancel;e.send=e.send;e.set=e.set;a(g.prototype);k.prototype={j:function(c){c=f(c||self,{o:!0});
if(!this.ports.has(c))return c.addListener(this.onMessage,this.j),this.ports.add(c),this},v:function(){var c=this;this.ports.forEach(function(b){b.removeListener(c.onMessage,c.v)})},onMessage:function(c){if(c.data.id&&c.data.type&&this.aa(c.data.s)&&(c=new g(c),this.a("message",c),!c.defaultPrevented))try{this.a(c.type,c)}catch(b){throw c.u(b),b;}},aa:function(b){return b==this.name||"*"==b||"*"==this.name},h:function(){this.v();delete this.name;return this}};e=k.prototype;e.listen=e.j;e.unlisten=
e.v;e.destroy=e.h;a(k.prototype)},{"../emitter":3,"../utils":7,"./port-adaptors":5}],5:[function(h,e){function d(b){this.target=b}function g(b,a,c){b.addEventListener(a,c)}var k=h("../utils").N;e.i=function(b,a){if(b.addListener)return b;var c=f[b.constructor.name];return c?c(b,a):new d(b)};var l=d.prototype={addListener:function(b){this.target.addEventListener("message",b)},removeListener:function(b){this.target.removeEventListener("message",b)},postMessage:function(b,a){this.target.postMessage(b,
a)}},f={HTMLIFrameElement:function(b){var d=a(b);return{addListener:function(b){window.addEventListener("message",b)},removeListener:function(b){window.removeEventListener("message",b)},postMessage:function(c,a){d.then(function(){b.contentWindow.postMessage(c,"*",a)})}}},la:function(b,a){function c(){var a=k();b.postMessage("ready?");g(b,"message",function n(c){"ready"==c.data&&(b.removeEventListener("message",n),a.resolve())});return a.K}var d=a&&a.o,e=a&&a.ready,e=e||d?Promise.resolve():c();d&&
(b.postMessage("ready"),g(b,"message",function(a){"ready?"==a.data&&b.postMessage("ready")}));return{target:b,addListener:l.addListener,removeListener:l.removeListener,postMessage:function(a,c){e.then(function(){return b.postMessage(a,c)})}}},Window:function(b,d){var c=d&&d.ready||b===self,c=c?Promise.resolve():a(b);return{addListener:function(b){window.addEventListener("message",b)},removeListener:function(b){window.removeEventListener("message",b)},postMessage:function(a,d){c.then(function(){return b.postMessage(a,
"*",d)})}}},SharedWorkerGlobalScope:function(){var b=[];return{postMessage:function(){},addListener:function(a,c){this.onconnect=function(a){a=a.ports[0];b.push(a);a.start();c(a)};self.addEventListener("connect",this.onconnect)},removeListener:function(a,c){self.removeEventListener("connect",this.onconnect);b.forEach(function(a){a.close();c(a)})}}}},a=function(){if("undefined"!=typeof window){var a=window.opener||window.parent,d=new WeakSet;a!=self&&g(window,"DOMContentLoaded",function q(){window.removeEventListener("DOMContentLoaded",
q);a.postMessage("load","*")});g(self,"message",function(a){return"load"==a.data&&d.add(a.source)});return function(a){var b=a.contentWindow||a;if(d.has(b)||b==window.parent)return Promise.resolve();var e=k();g(window,"message",function n(a){"load"==a.data&&a.source==b&&(window.removeEventListener("message",n),e.resolve())});return e.K}}}()},{"../utils":7}],6:[function(h,e){function d(a){if(!(this instanceof d))return new d(a);l.M.call(this,a);this.clients={};this.methods={};this.c("_disconnect",
this.onDisconnect.bind(this)).c("_connect",this.da.bind(this)).c("_method",this.ea.bind(this)).c("_off",this.fa.bind(this)).c("_on",this.ga.bind(this));this.h=this.h.bind(this)}function g(a){return Error({4:'method "'+[].slice.call(arguments,1)[0]+"\" doesn't exist"}[a])}var k=h("./utils").A,l=h("./message"),f=l.M;e.i=d;d.prototype=Object.create(f.prototype);d.prototype.method=function(a,b){this.methods[a]=b;return this};d.prototype.Y=function(a,b,d){var c={type:a,data:b};this.Z(function(a){d&&!~d.indexOf(a.id)||
l("_broadcast").set({s:a.id,l:!0,data:c}).send(a.endpoint)});return this};d.prototype.Z=function(a){for(var b in this.clients)a(this.clients[b])};d.prototype.da=function(a){var b=a.data,d=b.F;if(d&&b.D===this.name&&!this.clients[d]&&(this.a("before-connect",a),!a.defaultPrevented)){if(b=(b=a.event.ports)&&b[0])a.S(b),this.j(b),b.start();this.W(d,a.source);a.u();this.a("connected",d)}};d.prototype.onDisconnect=function(a){var b=this.clients[a.data];b&&(this.a("before-disconnect",a),a.defaultPrevented||
(this.P(b.id),a.u(),this.a("disconnected",b.id)))};d.prototype.ea=function(a){this.a("before-method",a);if(!a.defaultPrevented){var b=a.data,d=b.name,c=this.methods[d];if(!c)throw g(4,d);a.u(c.apply(this,b.X))}};d.prototype.ga=function(a){this.a("on",a.data)};d.prototype.fa=function(a){this.a("off",a.data)};d.prototype.W=function(a,b){this.clients[a]={id:a,endpoint:b}};d.prototype.P=function(a){delete this.clients[a]};d.prototype.J=function(a){a(this,{message:l,A:k});return this};d.prototype.disconnect=
function(a){this.P(a.id);l("disconnect").set({s:a.id,l:!0}).send(a.endpoint)};d.prototype.h=function(){delete this.clients;this.v();this.m()};f=d.prototype;f.broadcast=f.Y;f.destroy=f.h;f.method=f.method;f.plugin=f.J},{"./message":4,"./utils":7}],7:[function(h,e,d){d.A=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var e=16*Math.random()|0;return("x"==d?e:e&3|8).toString(16)})};d.N=function(){var d={};d.K=new Promise(function(e,h){d.resolve=e;d.reject=h});return d}},
{}]},{},[1]);
