(function p(e,d,g){function k(a,c){if(!d[a]){if(!e[a]){var m="function"==typeof require&&require;if(!c&&m)return m(a,!0);if(l)return l(a,!0);m=Error("Cannot find module '"+a+"'");throw m.code="MODULE_NOT_FOUND",m;}m=d[a]={g:{}};e[a][0].call(m.g,function(b){var c=e[a][1][b];return k(c?c:b)},m,m.g,p,e,d,g)}return d[a].g}for(var l="function"==typeof require&&require,f=0;f<g.length;f++)k(g[f]);return k})({1:[function(h){var e={service:h("../src/service"),client:h("../src/client"),ta:h("../src/message")};
"u"!=(typeof define)[0]?define([],function(){return e}):self.threads=e},{"../src/client":2,"../src/message":4,"../src/service":6}],2:[function(h,e){function d(c,a){if(!(this instanceof d))return new d(c,a);this.id=f();this.L(a);this.B=c;this.h=new Set;this.m=l.m(this.id).b("_broadcast",this.ea.bind(this));if(!this.endpoint)throw Error({1:"an endpoint must be defined"}[1]);}var g=h("./message/port-adaptors"),k=h("./emitter"),l=h("./message"),f=h("./utils").v;e.g=d;d.prototype={connect:function(){var c=
this;if(this.A)return this.A;var a=new MessageChannel;this.channel=a.port1;this.channel.start();var b={C:this.id,B:this.B};return this.A=this.message("_connect").set("transfer",[a.port2]).set("data",b).i(a.port1).send().then(function(b){b.event.target===c.channel?c.L(c.channel):(c.channel.close(),delete c.channel);c.m.i(c.endpoint)})},disconnect:function(c){var a=this;if(!this.A)return Promise.resolve();c={j:c&&c.j,data:this.id};this.ba();return this.message("_disconnect").set(c).send().then(function(){return a.fa()})},
method:function(c){var a=this,b=[].slice.call(arguments,1);return this.connect().then(function(){return a.message("_method","[Client]").set({o:a.B,data:{name:c,W:b}}).send()}).then(function(b){return b.value})},G:function(c){c(this,{message:l,sa:k,v:f});return this},message:function(c){var a=this,b=l(c).set("endpoint",this.endpoint).b("response",function(){return a.h.delete(b)}).b("cancel",function(){return a.h.delete(b)});this.h.add(b);return b},ba:function(){this.h.forEach(function(c){c.cancel()});
this.h.clear()},ga:function(){var c=[];this.h.forEach(function(a){return c.push(a.R)});return Promise.all(c)},ea:function(c){this.Z(c.data.type,c.data.data)},fa:function(){var c=this;delete this.A;this.ga().then(function(){c.channel&&c.channel.close();c.a("disconnected")})},L:function(c){c&&(this.endpoint=g(c));return this},f:function(){var c=this;return this.disconnect().then(function(){c.ca||(c.ca=!0,c.m.f(),c.$())})},$:k.prototype.l,Z:k.prototype.a};d.prototype.b=function(c,a){var b=this;this.connect().then(function(){k.prototype.b.call(b,
c,a);b.message("_on").set("noRespond",!0).set("data",{name:c,C:b.id}).send(b.endpoint)});return this};d.prototype.l=function(c,a){var b=this;this.connect().then(function(){k.prototype.l.call(b,c,a);b.message("_off").set("noRespond",!0).set("data",{name:c,C:b.id}).send(b.endpoint)});return this};var a=d.prototype;a.destroy=a.f;a.plugin=a.G;a.method=a.method;a.connect=a.connect;a.disconnect=a.disconnect;a.on=a.b;a.off=a.l},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":7}],3:[function(h,
e){function d(e){if(e)return Object.assign(e,d.prototype)}e.g=d;d.prototype={b:function(d,e){this.c||(this.c={});this.c[d]||(this.c[d]=[]);this.c[d].push(e);return this},l:function(d,e){if(this.c)switch(arguments.length){case 0:this.c={};break;case 1:delete this.c[d];break;default:var f=this.c[d];if(!f)return;var a=f.indexOf(e);~a&&f.splice(a,1)}return this},a:function(d,e){if(this.c)for(var f=this.c[d]||[],f=f.concat(this.c["*"]||[]),a=0;a<f.length;a++)f[a].call(this,e,d);return this}};var g=d.prototype;
g.off=g.l;g.on=g.b},{}],4:[function(h,e,d){function g(b){this.M=!1;this.K=null;this.D=[];this.onMessage=this.onMessage.bind(this);this.F=this.F.bind(this);"object"===typeof b?this.oa(b):this.pa(b)}function k(b){this.name=b;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this)}function l(b){return Error({1:".send() can only be called once",2:"response already sent for this message"}[b])}var f=h("./port-adaptors"),a=h("../emitter");
h=h("../utils");var c=h.N,m=h.v;d=e.g=function(b){return new g(b)};d.m=function(b){return new k(b)};d.J=k;d.h=g;g.prototype={timeout:1E3,pa:function(b){this.id=m();this.type=b;this.ma=!1;this.o="*"},oa:function(b){this.O=!1;this.S(b.source||b.target);this.event=b;Object.assign(this,b.data)},S:function(b){this.source=f(b,{ready:!0});return this},set:function(b,c){"object"==typeof b?Object.assign(this,b):this[b]=c;return this},na:function(){return{id:this.id,type:this.type,data:this.data,o:this.o,j:this.j}},
U:function(){this.defaultPrevented=!0},send:function(b){if(this.ma)throw l(1);var a=this.na(),d=!this.j;this.w=c();this.R=this.w.H;this.port=f(b||this.endpoint);d?(this.i(this.port),this.K=setTimeout(this.F,this.timeout)):this.w.resolve();this.port.postMessage(a,this.aa());return d?this.R:Promise.resolve()},aa:function(){return this.qa||this.event&&this.event.ports},onMessage:function(b){b.data.response&&b.data.id===this.id&&!this.M&&this.la(b)},F:function(){this.ua||this.w.reject("no response");
this.I()},i:function(b){b=f(b);b.addListener(this.onMessage);this.D.push(b);return this},u:function(){var b=this;this.D.forEach(function(c){return c.removeListener(b.onMessage)});this.D=[]},cancel:function(){this.I();this.M=!0;this.a("cancel")},I:function(){clearTimeout(this.K);this.u()},s:function(b){function c(b){d({type:"resolve",value:b})}function a(b){d({type:"reject",value:b&&b.message||b})}function d(b){e.response=b;e.source.postMessage({id:e.id,response:b},e.qa)}if(this.O)throw l(2);if(this.source&&
!this.j){var e=this;b instanceof Error&&a(b);Promise.resolve(b).then(c,a).catch(a);e.O=!0}},T:function(b){var c=this;return this.set("silentTimeout",!0).send(b).then(function(b){return c.s(b.value)})},la:function(b){var c=this.w,a=b.data.response,d="reject"==a.type?a.value:a;a.event=b;this.response=a;this.I();c[this.response.type](d);this.a("response",a)}};e=g.prototype;e.forward=e.T;e.respond=e.s;e.preventDefault=e.U;e.cancel=e.cancel;e.send=e.send;e.set=e.set;a(g.prototype);k.prototype={i:function(b){b=
f(b||self,{m:!0});if(!this.ports.has(b))return b.addListener(this.onMessage,this.i),this.ports.add(b),this},u:function(){var b=this;this.ports.forEach(function(c){c.removeListener(b.onMessage,b.u)})},onMessage:function(b){if(b.data.id&&b.data.type&&this.da(b.data.o)&&(b=new g(b),this.a("message",b),!b.defaultPrevented))try{this.a(b.type,b)}catch(c){throw b.s(c),c;}},da:function(b){return b==this.name||"*"==b||"*"==this.name},f:function(){this.u();delete this.name;return this}};e=k.prototype;e.listen=
e.i;e.unlisten=e.u;e.destroy=e.f;a(k.prototype)},{"../emitter":3,"../utils":7,"./port-adaptors":5}],5:[function(h,e){function d(c){this.target=c}function g(c,a,b){c.addEventListener(a,b)}var k=h("../utils").N;e.g=function(c,a){if(c.addListener)return c;var b=f[c.constructor.name];return b?b(c,a):new d(c)};var l=d.prototype={addListener:function(c){this.target.addEventListener("message",c)},removeListener:function(c){this.target.removeEventListener("message",c)},postMessage:function(c,a){this.target.postMessage(c,
a)}},f={HTMLIFrameElement:function(c){var d=a(c);return{addListener:function(b){window.addEventListener("message",b)},removeListener:function(b){window.removeEventListener("message",b)},postMessage:function(b,a){d.then(function(){c.contentWindow.postMessage(b,"*",a)})}}},ra:function(c,a){function b(){var b=k();c.postMessage("ready?");g(c,"message",function n(a){"ready"==a.data&&(c.removeEventListener("message",n),b.resolve())});return b.H}var d=a&&a.m,e=a&&a.ready,e=e||d?Promise.resolve():b();d&&
(c.postMessage("ready"),g(c,"message",function(b){"ready?"==b.data&&c.postMessage("ready")}));return{target:c,addListener:l.addListener,removeListener:l.removeListener,postMessage:function(b,a){e.then(function(){return c.postMessage(b,a)})}}},Window:function(c,d){var b=d&&d.ready||c===self,b=b?Promise.resolve():a(c);return{addListener:function(b){window.addEventListener("message",b)},removeListener:function(b){window.removeEventListener("message",b)},postMessage:function(a,d){b.then(function(){return c.postMessage(a,
"*",d)})}}},SharedWorkerGlobalScope:function(){var a=[];return{postMessage:function(){},addListener:function(d,b){this.onconnect=function(d){d=d.ports[0];a.push(d);d.start();b(d)};self.addEventListener("connect",this.onconnect)},removeListener:function(d,b){self.removeEventListener("connect",this.onconnect);a.forEach(function(a){a.close();b(a)})}}}},a=function(){if("undefined"!=typeof window){var a=window.opener||window.parent,d=new WeakSet;a!=self&&g(window,"DOMContentLoaded",function q(){window.removeEventListener("DOMContentLoaded",
q);a.postMessage("load","*")});g(self,"message",function(a){return"load"==a.data&&d.add(a.source)});return function(a){var c=a.contentWindow||a;if(d.has(c)||c==window.parent)return Promise.resolve();var e=k();g(window,"message",function n(a){"load"==a.data&&a.source==c&&(window.removeEventListener("message",n),e.resolve())});return e.H}}}()},{"../utils":7}],6:[function(h,e){function d(a){if(!(this instanceof d))return new d(a);l.J.call(this,a);this.clients={};this.methods={};this.b("_disconnect",
this.onDisconnect.bind(this)).b("_connect",this.ha.bind(this)).b("_method",this.ia.bind(this)).b("_off",this.ja.bind(this)).b("_on",this.ka.bind(this));this.f=this.f.bind(this)}function g(a){return Error({4:'method "'+[].slice.call(arguments,1)[0]+"\" doesn't exist"}[a])}var k=h("./utils").v,l=h("./message"),f=l.J;e.g=d;d.prototype=Object.create(f.prototype);d.prototype.method=function(a,c){this.methods[a]=c;return this};d.prototype.X=function(a,c,d){var b={type:a,data:c};this.Y(function(a){d&&!~d.indexOf(a.id)||
l("_broadcast").set({o:a.id,j:!0,data:b}).send(a.endpoint)});return this};d.prototype.Y=function(a){for(var c in this.clients)a(this.clients[c])};d.prototype.ha=function(a){var c=a.data,d=c.C;if(d&&c.B===this.name&&!this.clients[d]&&(this.a("before-connect",a),!a.defaultPrevented)){if(c=(c=a.event.ports)&&c[0])a.S(c),this.i(c),c.start();this.V(d,a.source);a.s();this.a("connected",d)}};d.prototype.onDisconnect=function(a){var c=this.clients[a.data];c&&(this.a("before-disconnect",a),a.defaultPrevented||
(this.P(c.id),a.s(),this.a("disconnected",c.id)))};d.prototype.ia=function(a){this.a("before-method",a);if(!a.defaultPrevented){var c=a.data,d=c.name,b,e=this.methods[d];if(!e)throw g(4,d);try{b=e.apply(this,c.W)}catch(f){b=f}a.s(b)}};d.prototype.ka=function(a){this.a("on",a.data)};d.prototype.ja=function(a){this.a("off",a.data)};d.prototype.V=function(a,c){this.clients[a]={id:a,endpoint:c}};d.prototype.P=function(a){delete this.clients[a]};d.prototype.G=function(a){a(this,{message:l,v:k});return this};
d.prototype.disconnect=function(a){this.P(a.id);l("disconnect").set({o:a.id,j:!0}).send(a.endpoint)};d.prototype.f=function(){delete this.clients;this.u();this.l()};f=d.prototype;f.broadcast=f.X;f.destroy=f.f;f.method=f.method;f.plugin=f.G},{"./message":4,"./utils":7}],7:[function(h,e,d){d.v=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var e=16*Math.random()|0;return("x"==d?e:e&3|8).toString(16)})};d.N=function(){var d={};d.H=new Promise(function(e,h){d.resolve=
e;d.reject=h});return d}},{}]},{},[1]);
