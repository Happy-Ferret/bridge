(function p(e,c,g){function k(b,a){if(!c[b]){if(!e[b]){var m="function"==typeof require&&require;if(!a&&m)return m(b,!0);if(l)return l(b,!0);m=Error("Cannot find module '"+b+"'");throw m.code="MODULE_NOT_FOUND",m;}m=c[b]={h:{}};e[b][0].call(m.h,function(d){var a=e[b][1][d];return k(a?a:d)},m,m.h,p,e,c,g)}return c[b].h}for(var l="function"==typeof require&&require,f=0;f<g.length;f++)k(g[f]);return k})({1:[function(h){var e={service:h("../src/service"),client:h("../src/client"),ta:h("../src/message")};
"u"!=(typeof define)[0]?define([],function(){return e}):self.threads=e},{"../src/client":2,"../src/message":4,"../src/service":6}],2:[function(h,e){function c(a,b){if(!(this instanceof c))return new c(a,b);this.id=f();this.B=a;this.w=b||this.w;if(!this.w)throw Error({1:"an endpoint must be defined"}[1]);this.P(this.w);this.i=new Set;this.m=l.m(this.id).b("_push",this.ga.bind(this))}var g=h("./message/port-adaptors"),k=h("./emitter"),l=h("./message"),f=h("./utils").K;e.h=c;c.prototype={connect:function(){var a=
this;if(this.A)return this.A;var b=new MessageChannel;this.channel=b.port1;this.channel.start();var d={C:this.id,B:this.B};return this.A=this.message("_connect").set("transfer",[b.port2]).set("data",d).l(b.port1).send().then(function(d){d.event.target===a.channel?a.P(a.channel):(a.channel.close(),delete a.channel);a.m.l(a.port)})},disconnect:function(a){var b=this;if(!this.A)return Promise.resolve();a={f:a&&a.f,data:this.id};this.ca();return this.message("_disconnect").set(a).send().then(function(){return b.fa()})},
method:function(a){var b=this,d=[].slice.call(arguments,1);return this.connect().then(function(){return b.message("_method","[Client]").set({s:b.B,data:{name:a,X:d}}).send()}).then(function(d){return d.value})},G:function(a){a(this,{Emitter:k,uuid:f});return this},message:function(a){var b=this,d=l(a).set("port",this.port).b("response",function(){return b.i.delete(d)}).b("cancel",function(){return b.i.delete(d)});this.i.add(d);return d},ca:function(){this.i.forEach(function(a){a.cancel()});this.i.clear()},
ha:function(){var a=[];this.i.forEach(function(b){return a.push(b.ua)});return Promise.all(a)},ga:function(a){this.O(a.data.type,a.data.data)},fa:function(){var a=this;delete this.A;this.ha().then(function(){a.channel&&a.channel.close();a.O("disconnected")})},P:function(a){this.port=g(a)},g:function(){var a=this;return this.disconnect().then(function(){a.ea||(a.ea=!0,a.m.g(),a.ba(),a.port=a.w=a.m=null)})},ba:k.prototype.o,O:k.prototype.a};c.prototype.b=function(a,b){var d=this;this.connect().then(function(){k.prototype.b.call(d,
a,b);d.message("_on").set("noRespond",!0).set("data",{name:a,C:d.id}).send(d.port)});return this};c.prototype.o=function(a,b){var d=this;this.connect().then(function(){k.prototype.o.call(d,a,b);d.message("_off").set("noRespond",!0).set("data",{name:a,C:d.id}).send(d.port)});return this};var b=c.prototype;b.destroy=b.g;b.plugin=b.G;b.method=b.method;b.connect=b.connect;b.disconnect=b.disconnect;b.on=b.b;b.off=b.o},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":7}],3:[function(h,
e){function c(e){if(e)return Object.assign(e,c.prototype)}e.h=c;c.prototype={b:function(c,e){this.c||(this.c={});this.c[c]||(this.c[c]=[]);this.c[c].push(e);return this},o:function(c,e){if(this.c)switch(arguments.length){case 0:this.c={};break;case 1:delete this.c[c];break;default:var f=this.c[c];if(!f)return;var b=f.indexOf(e);~b&&f.splice(b,1)}return this},a:function(c,e){if(this.c)for(var f=this.c[c]||[],f=f.concat(this.c["*"]||[]),b=0;b<f.length;b++)f[b].call(this,e,c);return this}};var g=c.prototype;
g.off=g.o;g.on=g.b},{}],4:[function(h,e,c){function g(d){this.N=!1;this.M=null;this.D=[];this.j=a();this.onMessage=this.onMessage.bind(this);this.F=this.F.bind(this);"object"===typeof d?this.pa(d):this.qa(d)}function k(d){this.name=d;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this)}function l(d){return Error({1:".send() can only be called once",2:"response already sent for this message",3:"a port must be defined"}[d])}
var f=h("./port-adaptors"),b=h("../emitter");h=h("../utils");var a=h.j,m=h.K;c=e.h=function(d){return new g(d)};c.m=function(d){return new k(d)};c.L=k;c.i=g;g.prototype={timeout:1E3,qa:function(d){this.id=m();this.type=d;this.na=!1;this.s="*"},pa:function(d){this.R=!1;this.T(d.source||d.target);this.event=d;Object.assign(this,d.data)},T:function(d){this.I=f(d,{ready:!0});return this},set:function(d,a){"object"==typeof d?Object.assign(this,d):this[d]=a;return this},oa:function(){return{id:this.id,
type:this.type,data:this.data,s:this.s,f:this.f}},V:function(){this.defaultPrevented=!0},send:function(d){if(this.na)throw l(1);var a=this.oa(),b=!this.f;this.port=d?f(d):this.port;if(!this.port)throw l(3);b?(this.l(this.port),this.M=setTimeout(this.F,this.timeout)):this.j.resolve();this.port.postMessage(a,this.aa());return this.j.H},aa:function(){return this.ra||this.event&&this.event.ports},onMessage:function(d){d.data.response&&d.data.id===this.id&&!this.N&&this.ma(d)},F:function(){this.va||this.j.reject("no response");
this.J()},l:function(d){d=f(d);d.addListener(this.onMessage);this.D.push(d);return this},v:function(){var d=this;this.D.forEach(function(a){return a.removeListener(d.onMessage)});this.D=[]},cancel:function(){this.J();this.N=!0;this.a("cancel")},J:function(){clearTimeout(this.M);this.v()},u:function(a){function b(a){e({type:"resolve",value:a})}function c(a){e({type:"reject",value:a&&a.message||a})}function e(a){m.response=a;m.I.postMessage({id:m.id,response:a},m.ra)}if(this.R)throw l(2);if(this.I&&
!this.f){var m=this;this.R=!0;a instanceof Error&&c(a);Promise.resolve(a).then(b,c).catch(c)}},U:function(a){var b=this;return this.set("silentTimeout",!0).send(a).then(function(a){return b.u(a.value)})},ma:function(a){var b=a.data.response,c="reject"==b.type?b.value:b;b.event=a;this.response=b;this.J();this.j[this.response.type](c);this.a("response",b)}};e=g.prototype;e.forward=e.U;e.respond=e.u;e.preventDefault=e.V;e.cancel=e.cancel;e.send=e.send;e.set=e.set;b(g.prototype);k.prototype={l:function(a){a=
f(a||self,{m:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.l),this.ports.add(a),this},v:function(){var a=this;this.ports.forEach(function(b){b.removeListener(a.onMessage,a.v)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.da(a.data.s)&&(a=new g(a),this.a("message",a),!a.defaultPrevented))try{this.a(a.type,a)}catch(b){throw a.u(b),b;}},da:function(a){return a==this.name||"*"==a||"*"==this.name},g:function(){this.v();delete this.name;return this}};e=k.prototype;e.listen=
e.l;e.unlisten=e.v;e.destroy=e.g;b(k.prototype)},{"../emitter":3,"../utils":7,"./port-adaptors":5}],5:[function(h,e){function c(a){this.target=a}function g(a,b,d){a.addEventListener(b,d)}var k=h("../utils").j;e.h=function(a,b){if(!a)throw Error({1:"target is undefined"}[1]);if(a&&a.addListener)return a;var d=f[a.constructor.name];return d?d(a,b):new c(a)};var l=c.prototype={constructor:c,addListener:function(a){this.target.addEventListener("message",a)},removeListener:function(a){this.target.removeEventListener("message",
a)},postMessage:function(a,b){this.target.postMessage(a,b)}},f={HTMLIFrameElement:function(a){var c=b(a);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(b,e){c.then(function(){a.contentWindow.postMessage(b,"*",e)})}}},sa:function(a,b){function d(){var b=k();a.postMessage("ready?");g(a,"message",function n(d){"ready"==d.data&&(a.removeEventListener("message",n),b.resolve())});return b.H}var c=
b&&b.m,e=b&&b.ready,e=e||c?Promise.resolve():d();c&&(a.postMessage("ready"),g(a,"message",function(b){"ready?"==b.data&&a.postMessage("ready")}));return{target:a,addListener:l.addListener,removeListener:l.removeListener,postMessage:function(b,d){e.then(function(){return a.postMessage(b,d)})}}},Window:function(a,c){var d=c&&c.ready||a===self,d=d?Promise.resolve():b(a);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",
a)},postMessage:function(b,c){d.then(function(){return a.postMessage(b,"*",c)})}}},SharedWorkerGlobalScope:function(){var a=[];return{postMessage:function(){},addListener:function(b,d){this.onconnect=function(b){b=b.ports[0];a.push(b);b.start();d(b)};self.addEventListener("connect",this.onconnect)},removeListener:function(b,d){self.removeEventListener("connect",this.onconnect);a.forEach(function(a){a.close();d(a)})}}}},b=function(){if("undefined"!=typeof window){var a=window.opener||window.parent,
b=new WeakSet;a!=self&&g(window,"DOMContentLoaded",function q(){window.removeEventListener("DOMContentLoaded",q);a.postMessage("load","*")});g(self,"message",function(a){return"load"==a.data&&b.add(a.source)});return function(a){var c=a.contentWindow||a;if(b.has(c)||c==window.parent)return Promise.resolve();var e=k();g(window,"message",function n(a){"load"==a.data&&a.source==c&&(window.removeEventListener("message",n),e.resolve())});return e.H}}}()},{"../utils":7}],6:[function(h,e){function c(b){if(!(this instanceof
c))return new c(b);l.L.call(this,b);this.clients={};this.methods={};this.b("_disconnect",this.onDisconnect.bind(this)).b("_connect",this.ia.bind(this)).b("_method",this.ja.bind(this)).b("_off",this.ka.bind(this)).b("_on",this.la.bind(this));this.g=this.g.bind(this)}function g(b){return Error({4:'method "'+[].slice.call(arguments,1)[0]+"\" doesn't exist"}[b])}var k=h("./utils").K,l=h("./message"),f=l.L;e.h=c;c.prototype=Object.create(f.prototype);c.prototype.method=function(b,a){this.methods[b]=a;
return this};c.prototype.Y=function(b,a,c){var d=this;this.Z(function(e){c&&!~c.indexOf(e.id)||d.push(b,a,e.id,{f:!0})});return this};c.prototype.push=function(b,a,c,d){d=d&&d.f;var e=this.$(c);return l("_push").set({s:c,f:d,data:{type:b,data:a}}).send(e.port)};c.prototype.Z=function(b){for(var a in this.clients)b(this.clients[a])};c.prototype.$=function(b){return this.clients[b]};c.prototype.ia=function(b){var a=b.data,c=a.C;if(c&&a.B===this.name&&!this.clients[c]&&(this.a("before-connect",b),!b.defaultPrevented)){if(a=
(a=b.event.ports)&&a[0])b.T(a),this.l(a),a.start();this.W(c,b.I);b.u();this.a("connected",c)}};c.prototype.onDisconnect=function(b){var a=this.clients[b.data];a&&(this.a("before-disconnect",b),b.defaultPrevented||(this.S(a.id),b.u(),this.a("disconnected",a.id)))};c.prototype.ja=function(b){this.a("before-method",b);if(!b.defaultPrevented){var a=b.data,c=a.name,d,e=this.methods[c];if(!e)throw g(4,c);try{d=e.apply(this,a.X)}catch(f){d=f}b.u(d)}};c.prototype.la=function(b){this.a("on",b.data)};c.prototype.ka=
function(b){this.a("off",b.data)};c.prototype.W=function(b,a){this.clients[b]={id:b,port:a}};c.prototype.S=function(b){delete this.clients[b]};c.prototype.G=function(b){b(this,{uuid:k});return this};c.prototype.disconnect=function(b){this.S(b.id);l("disconnect").set({s:b.id,f:!0}).send(b.port)};c.prototype.g=function(){delete this.clients;this.v();this.o()};f=c.prototype;f.broadcast=f.Y;f.destroy=f.g;f.method=f.method;f.plugin=f.G},{"./message":4,"./utils":7}],7:[function(h,e,c){c.K=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,
function(c){var e=16*Math.random()|0;return("x"==c?e:e&3|8).toString(16)})};c.j=function(){var c={};c.H=new Promise(function(e,h){c.resolve=e;c.reject=h});return c}},{}]},{},[1]);
