(function p(d,c,f){function k(b,a){if(!c[b]){if(!d[b]){var m="function"==typeof require&&require;if(!a&&m)return m(b,!0);if(l)return l(b,!0);m=Error("Cannot find module '"+b+"'");throw m.code="MODULE_NOT_FOUND",m;}m=c[b]={g:{}};d[b][0].call(m.g,function(h){var a=d[b][1][h];return k(a?a:h)},m,m.g,p,d,c,f)}return c[b].g}for(var l="function"==typeof require&&require,e=0;e<f.length;e++)k(f[e]);return k})({1:[function(g){var d={service:g("../src/service"),client:g("../src/client"),ta:g("../src/message")};
"u"!=(typeof define)[0]?define([],function(){return d}):self.threads=d},{"../src/client":2,"../src/message":4,"../src/service":6}],2:[function(g,d){function c(a,b){if(!(this instanceof c))return new c(a,b);this.id=e();this.B=a;this.endpoint=b||this.endpoint;if(!this.endpoint)throw Error({1:"an endpoint must be defined"}[1]);this.O(this.endpoint);this.h=new Set;this.l=l.l(this.id).b("_broadcast",this.ea.bind(this))}var f=g("./message/port-adaptors"),k=g("./emitter"),l=g("./message"),e=g("./utils").v;
d.g=c;c.prototype={connect:function(){var a=this;if(this.A)return this.A;var b=new MessageChannel;this.channel=b.port1;this.channel.start();var h={C:this.id,B:this.B};return this.A=this.message("_connect").set("transfer",[b.port2]).set("data",h).i(b.port1).send().then(function(h){h.event.target===a.channel?a.O(a.channel):(a.channel.close(),delete a.channel);a.l.i(a.port)})},disconnect:function(a){var b=this;if(!this.A)return Promise.resolve();a={j:a&&a.j,data:this.id};this.ba();return this.message("_disconnect").set(a).send().then(function(){return b.fa()})},
method:function(a){var b=this,h=[].slice.call(arguments,1);return this.connect().then(function(){return b.message("_method","[Client]").set({o:b.B,data:{name:a,X:h}}).send()}).then(function(a){return a.value})},G:function(a){a(this,{message:l,sa:k,v:e});return this},message:function(a){var b=this,h=l(a).set("endpoint",this.port).b("response",function(){return b.h.delete(h)}).b("cancel",function(){return b.h.delete(h)});this.h.add(h);return h},ba:function(){this.h.forEach(function(a){a.cancel()});
this.h.clear()},ga:function(){var a=[];this.h.forEach(function(b){return a.push(b.S)});return Promise.all(a)},ea:function(a){this.L(a.data.type,a.data.data)},fa:function(){var a=this;delete this.A;this.ga().then(function(){a.channel&&a.channel.close();a.L("disconnected")})},O:function(a){this.port=f(a)},f:function(){var a=this;return this.disconnect().then(function(){a.ca||(a.ca=!0,a.l.f(),a.$(),a.port=a.endpoint=a.l=null)})},$:k.prototype.m,L:k.prototype.a};c.prototype.b=function(a,b){var h=this;
this.connect().then(function(){k.prototype.b.call(h,a,b);h.message("_on").set("noRespond",!0).set("data",{name:a,C:h.id}).send(h.port)});return this};c.prototype.m=function(a,b){var h=this;this.connect().then(function(){k.prototype.m.call(h,a,b);h.message("_off").set("noRespond",!0).set("data",{name:a,C:h.id}).send(h.port)});return this};var b=c.prototype;b.destroy=b.f;b.plugin=b.G;b.method=b.method;b.connect=b.connect;b.disconnect=b.disconnect;b.on=b.b;b.off=b.m},{"./emitter":3,"./message":4,"./message/port-adaptors":5,
"./utils":7}],3:[function(g,d){function c(d){if(d)return Object.assign(d,c.prototype)}d.g=c;c.prototype={b:function(c,d){this.c||(this.c={});this.c[c]||(this.c[c]=[]);this.c[c].push(d);return this},m:function(c,d){if(this.c)switch(arguments.length){case 0:this.c={};break;case 1:delete this.c[c];break;default:var e=this.c[c];if(!e)return;var b=e.indexOf(d);~b&&e.splice(b,1)}return this},a:function(c,d){if(this.c)for(var e=this.c[c]||[],e=e.concat(this.c["*"]||[]),b=0;b<e.length;b++)e[b].call(this,
d,c);return this}};var f=c.prototype;f.off=f.m;f.on=f.b},{}],4:[function(g,d,c){function f(a){this.M=!1;this.K=null;this.D=[];this.onMessage=this.onMessage.bind(this);this.F=this.F.bind(this);"object"===typeof a?this.oa(a):this.pa(a)}function k(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this)}function l(a){return Error({1:".send() can only be called once",2:"response already sent for this message"}[a])}
var e=g("./port-adaptors"),b=g("../emitter");g=g("../utils");var a=g.N,m=g.v;c=d.g=function(a){return new f(a)};c.l=function(a){return new k(a)};c.J=k;c.h=f;f.prototype={timeout:1E3,pa:function(a){this.id=m();this.type=a;this.ma=!1;this.o="*"},oa:function(a){this.P=!1;this.T(a.source||a.target);this.event=a;Object.assign(this,a.data)},T:function(a){this.source=e(a,{ready:!0});return this},set:function(a,b){"object"==typeof a?Object.assign(this,a):this[a]=b;return this},na:function(){return{id:this.id,
type:this.type,data:this.data,o:this.o,j:this.j}},V:function(){this.defaultPrevented=!0},send:function(b){if(this.ma)throw l(1);var c=this.na(),d=!this.j;this.w=a();this.S=this.w.H;this.port=e(b||this.endpoint);d?(this.i(this.port),this.K=setTimeout(this.F,this.timeout)):this.w.resolve();this.port.postMessage(c,this.aa());return d?this.S:Promise.resolve()},aa:function(){return this.qa||this.event&&this.event.ports},onMessage:function(a){a.data.response&&a.data.id===this.id&&!this.M&&this.la(a)},F:function(){this.ua||
this.w.reject("no response");this.I()},i:function(a){a=e(a);a.addListener(this.onMessage);this.D.push(a);return this},u:function(){var a=this;this.D.forEach(function(b){return b.removeListener(a.onMessage)});this.D=[]},cancel:function(){this.I();this.M=!0;this.a("cancel")},I:function(){clearTimeout(this.K);this.u()},s:function(a){function b(a){d({type:"resolve",value:a})}function c(a){d({type:"reject",value:a&&a.message||a})}function d(a){m.response=a;m.source.postMessage({id:m.id,response:a},m.qa)}
if(this.P)throw l(2);if(this.source&&!this.j){var m=this;a instanceof Error&&c(a);Promise.resolve(a).then(b,c).catch(c);m.P=!0}},U:function(a){var b=this;return this.set("silentTimeout",!0).send(a).then(function(a){return b.s(a.value)})},la:function(a){var b=this.w,c=a.data.response,d="reject"==c.type?c.value:c;c.event=a;this.response=c;this.I();b[this.response.type](d);this.a("response",c)}};d=f.prototype;d.forward=d.U;d.respond=d.s;d.preventDefault=d.V;d.cancel=d.cancel;d.send=d.send;d.set=d.set;
b(f.prototype);k.prototype={i:function(a){a=e(a||self,{l:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.i),this.ports.add(a),this},u:function(){var a=this;this.ports.forEach(function(b){b.removeListener(a.onMessage,a.u)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.da(a.data.o)&&(a=new f(a),this.a("message",a),!a.defaultPrevented))try{this.a(a.type,a)}catch(b){throw a.s(b),b;}},da:function(a){return a==this.name||"*"==a||"*"==this.name},f:function(){this.u();delete this.name;
return this}};d=k.prototype;d.listen=d.i;d.unlisten=d.u;d.destroy=d.f;b(k.prototype)},{"../emitter":3,"../utils":7,"./port-adaptors":5}],5:[function(g,d){function c(a){this.target=a}function f(a,b,c){a.addEventListener(b,c)}var k=g("../utils").N;d.g=function(a,b){if(!a)throw Error({1:"target is undefined"}[1]);if(a&&a.addListener)return a;var d=e[a.constructor.name];return d?d(a,b):new c(a)};var l=c.prototype={constructor:c,addListener:function(a){this.target.addEventListener("message",a)},removeListener:function(a){this.target.removeEventListener("message",
a)},postMessage:function(a,b){this.target.postMessage(a,b)}},e={HTMLIFrameElement:function(a){var c=b(a);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(b,d){c.then(function(){a.contentWindow.postMessage(b,"*",d)})}}},ra:function(a,b){function c(){var b=k();a.postMessage("ready?");f(a,"message",function n(c){"ready"==c.data&&(a.removeEventListener("message",n),b.resolve())});return b.H}var d=
b&&b.l,e=b&&b.ready,e=e||d?Promise.resolve():c();d&&(a.postMessage("ready"),f(a,"message",function(b){"ready?"==b.data&&a.postMessage("ready")}));return{target:a,addListener:l.addListener,removeListener:l.removeListener,postMessage:function(b,c){e.then(function(){return a.postMessage(b,c)})}}},Window:function(a,c){var d=c&&c.ready||a===self,d=d?Promise.resolve():b(a);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",
a)},postMessage:function(b,c){d.then(function(){return a.postMessage(b,"*",c)})}}},SharedWorkerGlobalScope:function(){var a=[];return{postMessage:function(){},addListener:function(b,c){this.onconnect=function(b){b=b.ports[0];a.push(b);b.start();c(b)};self.addEventListener("connect",this.onconnect)},removeListener:function(b,c){self.removeEventListener("connect",this.onconnect);a.forEach(function(a){a.close();c(a)})}}}},b=function(){if("undefined"!=typeof window){var a=window.opener||window.parent,
b=new WeakSet;a!=self&&f(window,"DOMContentLoaded",function q(){window.removeEventListener("DOMContentLoaded",q);a.postMessage("load","*")});f(self,"message",function(a){return"load"==a.data&&b.add(a.source)});return function(a){var c=a.contentWindow||a;if(b.has(c)||c==window.parent)return Promise.resolve();var d=k();f(window,"message",function n(a){"load"==a.data&&a.source==c&&(window.removeEventListener("message",n),d.resolve())});return d.H}}}()},{"../utils":7}],6:[function(g,d){function c(b){if(!(this instanceof
c))return new c(b);l.J.call(this,b);this.clients={};this.methods={};this.b("_disconnect",this.onDisconnect.bind(this)).b("_connect",this.ha.bind(this)).b("_method",this.ia.bind(this)).b("_off",this.ja.bind(this)).b("_on",this.ka.bind(this));this.f=this.f.bind(this)}function f(b){return Error({4:'method "'+[].slice.call(arguments,1)[0]+"\" doesn't exist"}[b])}var k=g("./utils").v,l=g("./message"),e=l.J;d.g=c;c.prototype=Object.create(e.prototype);c.prototype.method=function(b,a){this.methods[b]=a;
return this};c.prototype.Y=function(b,a,c){var d={type:b,data:a};this.Z(function(a){c&&!~c.indexOf(a.id)||l("_broadcast").set({o:a.id,j:!0,data:d}).send(a.endpoint)});return this};c.prototype.Z=function(b){for(var a in this.clients)b(this.clients[a])};c.prototype.ha=function(b){var a=b.data,c=a.C;if(c&&a.B===this.name&&!this.clients[c]&&(this.a("before-connect",b),!b.defaultPrevented)){if(a=(a=b.event.ports)&&a[0])b.T(a),this.i(a),a.start();this.W(c,b.source);b.s();this.a("connected",c)}};c.prototype.onDisconnect=
function(b){var a=this.clients[b.data];a&&(this.a("before-disconnect",b),b.defaultPrevented||(this.R(a.id),b.s(),this.a("disconnected",a.id)))};c.prototype.ia=function(b){this.a("before-method",b);if(!b.defaultPrevented){var a=b.data,c=a.name,d,e=this.methods[c];if(!e)throw f(4,c);try{d=e.apply(this,a.X)}catch(k){d=k}b.s(d)}};c.prototype.ka=function(b){this.a("on",b.data)};c.prototype.ja=function(b){this.a("off",b.data)};c.prototype.W=function(b,a){this.clients[b]={id:b,endpoint:a}};c.prototype.R=
function(b){delete this.clients[b]};c.prototype.G=function(b){b(this,{message:l,v:k});return this};c.prototype.disconnect=function(b){this.R(b.id);l("disconnect").set({o:b.id,j:!0}).send(b.endpoint)};c.prototype.f=function(){delete this.clients;this.u();this.m()};e=c.prototype;e.broadcast=e.Y;e.destroy=e.f;e.method=e.method;e.plugin=e.G},{"./message":4,"./utils":7}],7:[function(g,d,c){c.v=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var d=16*Math.random()|0;
return("x"==c?d:d&3|8).toString(16)})};c.N=function(){var c={};c.H=new Promise(function(d,g){c.resolve=d;c.reject=g});return c}},{}]},{},[1]);
