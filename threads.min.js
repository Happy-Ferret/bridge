!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.threads=e()}}(function(){return function e(t,n,s){function i(o,a){if(!n[o]){if(!t[o]){var c="function"==typeof require&&require;if(!a&&c)return c(o,!0);if(r)return r(o,!0);var h=new Error("Cannot find module '"+o+"'");throw h.code="MODULE_NOT_FOUND",h}var d=n[o]={exports:{}};t[o][0].call(d.exports,function(e){var n=t[o][1][e];return i(n?n:e)},d,d.exports,e,t,n,s)}return n[o].exports}for(var r="function"==typeof require&&require,o=0;o<s.length;o++)i(s[o]);return i}({1:[function(require,module,exports){module.exports={create:require("./lib/child-thread"),manager:require("./lib/manager"),service:require("./lib/service"),client:require("./lib/client")}},{"./lib/child-thread":2,"./lib/client":3,"./lib/manager":6,"./lib/service":8}],2:[function(require,module,exports){"use strict";function e(t){return this instanceof e?(this.id=i.uuid(),this.src=t.src,this.type=t.type,this.parentNode=t.parentNode,this.target=t.target||this.createTarget(),this.threadId=void 0,this.services={},this.onmessage=this.onmessage.bind(this),this.messenger=new n(this.id,"[ChildThread]").handle("redundant",this.onredundant,this).handle("serviceready",this.onserviceready,this),this.listen(),this.ready=this.checkReady(),void r("initialized",this.type)):new e(t)}function t(e){var t=[].slice.call(arguments,1);return new Error({1:"iframes can't be spawned from workers",2:'Request to get service "'+t[0]+'" timed out'}[e])}var n=require("./messenger"),s=require("./emitter"),i=require("./utils");module.exports=e;var r=function(){};e.prototype=Object.create(s.prototype),e.prototype.createTarget=function(){r("create process");var e=i.uuid();switch(this.type){case"worker":return new Worker(this.src+"?pid="+e);case"sharedworker":return new SharedWorker(this.src+"?pid="+e);case"window":if("window"!==i.env())throw t(1);var n=document.createElement("iframe");return(this.parentNode||document.body).appendChild(n),n.name=e,n.src=this.src,n}},e.prototype.getService=function(e){return r("get service when ready...",e),this.ready.then(function(){return this._getService(e)}.bind(this))},e.prototype._getService=function(e){function n(t){t.name===e&&(r("service ready",t.name),a.off("serviceready",n),clearTimeout(c),o.resolve(t))}r("get service",e);var s=this.services[e];if(s)return r("service already known"),Promise.resolve(s);var o=i.deferred(),a=this;this.on("serviceready",n);var c=setTimeout(function(){a.off("serviceready",n),o.reject(t(2,e))},2e3);return o.promise},e.prototype.checkReady=function(){function e(e){n++||(r("thread ready",e),s.messenger.unhandle("threadready"),s.threadId=e.id,s.services=e.services,t.resolve())}r("check ready");var t=i.deferred(),n=0,s=this;return this.messenger.handle("threadready",e),this.messenger.request(this,{type:"ping"}).then(e),t.promise},e.prototype.postMessage=function(e){switch(r("post message",e),this.type){case"worker":this.target.postMessage(e);break;case"sharedworker":this.target.port.postMessage(e);break;case"window":if(!this.target.contentWindow)return;this.target.contentWindow.postMessage(e,"*")}},e.prototype.listen=function(){switch(r("listen (%s)",this.type),this.type){case"worker":this.target.addEventListener("message",this.onmessage);break;case"sharedworker":this.target.port.start(),this.target.port.addEventListener("message",this.onmessage);break;case"window":addEventListener("message",this.onmessage)}},e.prototype.onmessage=function(e){r("on message",e.data.type),this.messenger.parse(e),this.emit("message",e)},e.prototype.unlisten=function(){switch(this.type){case"worker":this.target.removeEventListener("message",this.messenger.parse);break;case"sharedworker":this.target.port.close(),this.target.port.removeEventListener("message",this.messenger.parse);break;case"window":removeEventListener("message",this.messenger.parse)}},e.prototype.onserviceready=function(e){r("on service ready",e),this.services[e.name]=e,this.emit("serviceready",e)},e.prototype.onredundant=function(){r("redundant"),this.emit("redundant")},e.prototype.destroy=function(){this.unlisten(),this.destroyTarget(),this.off()},e.prototype.destroyTarget=function(){switch(r("destroy thread (%s)"),this.type){case"worker":this.target.terminate();break;case"sharedworker":this.target.port.close();break;case"window":this.target.remove()}delete this.target}},{"./emitter":5,"./messenger":7,"./utils":11}],3:[function(require,module,exports){"use strict";function e(t,n){return this instanceof e?(this.contract=n&&n.contract,this.thread=n&&n.thread,this.id=r.uuid(),this._activeStreams={},this._connected=!1,this.service={channel:void 0,name:t,id:void 0},this.messenger=new s(this.id,"client").handle("streamevent",this.onstreamevent,this).handle("broadcast",this.onbroadcast,this),this.thread&&this.thread.on("message",this.messenger.parse),o.addEventListener("message",this.messenger.parse),this.connect(),void a("initialized",t)):new e(t,n)}var t=require("../thread-global"),n=require("./stream"),s=require("../messenger"),i=require("../emitter"),r=require("../utils");module.exports=e;var o=new BroadcastChannel("threadsmanager"),a=function(){};e.prototype=Object.create(i.prototype),e.prototype.connect=function(){if(this.connected)return this.connected;a("connecting...");var e=this;return this.service.channel=new BroadcastChannel(this.id),this.service.channel.onmessage=this.messenger.parse,this.connected=this.thread?this.connectViaThread():this.connectViaManager(),this.connected.then(function(n){a("connected",n),e.service.id=n.id,t.connection("outbound")})},e.prototype.connectViaThread=function(){a("connect via thread");var e=this;return this.thread.getService(e.service.name).then(function(t){return a("got service",t),e.messenger.request(e.thread,{type:"connect",recipient:t.id,data:{client:e.id,service:t.name,contract:e.contract}})})},e.prototype.connectViaManager=function(){return a("connect via manager"),this.messenger.request(o,{type:"connect",recipient:"*",data:{service:this.service.name,client:this.id}})},e.prototype.disconnect=function(){return a("disconnect"),this.connected?this.request("disconnect",this.id).then(function(){this.service.channel.close(),delete this.service.channel,delete this.service.id,delete this.connected,t.disconnection("outbound"),a("disconnected")}.bind(this)):Promise.resolve()},e.prototype.request=function(e,t){return a("request",e,t),this.connect().then(function(){return this.messenger.request(this.service.channel,{type:e,recipient:this.service.id,data:t})}.bind(this))},e.prototype.onbroadcast=function(e){a("on broadcast",e),this.emit(e.type,e.data)},e.prototype.method=function(e){var t=[].slice.call(arguments,1);return a("method",e,t),this.request("method",{name:e,args:t})},e.prototype.stream=function(e){a("stream",e,t);var t=[].slice.call(arguments,1),s=this,i=r.uuid(),o=new n({id:i,client:this});return this._activeStreams[i]=o,this.request("stream",{name:e,args:t,id:i})["catch"](function(e){s.onstreamevent({type:"abort",id:i,data:e})}),o},e.prototype.onstreamevent=function(e){var t=e.id,n=e.type,s=this._activeStreams[t];s._[n](e.data),("abort"===n||"close"===n)&&delete this._activeStreams[t]}},{"../emitter":5,"../messenger":7,"../thread-global":10,"../utils":11,"./stream":4}],4:[function(require,module,exports){"use strict";function e(e){this._=new t(e)}function t(e){this.id=e.id,this.client=e.client,this.closed=s.deferred(),this.emitter=new n,i("initialized")}var n=require("../emitter"),s=require("../utils");module.exports=e;var i=function(){};Object.defineProperty(e.prototype,"closed",{get:function(){return this._.closed.promise}}),e.prototype.listen=function(e){i("listen",e),this._.emitter.on("write",e)},e.prototype.unlisten=function(e){i("unlisten",e),this._.emitter.off("write",e)},e.prototype.cancel=function(e){i("cancel",e);var t=s.deferred(),n=this._.client,r=this._.id;return n.request("streamcancel",{id:r,reason:e}).then(function(e){delete n._activeStreams[r],t.resolve(e)})["catch"](function(e){delete n._activeStreams[r],t.reject(e)}),t.promise},t.prototype.abort=function(e){i("abort",e),this.closed.reject(e)},t.prototype.close=function(){i("close"),this.closed.resolve()},t.prototype.write=function(e){i("write",e),this.emitter.emit("write",e)}},{"../emitter":5,"../utils":11}],5:[function(require,module,exports){"use strict";function e(){}module.exports=e;var t=function(){};e.prototype.on=function(e,n){return t("on",e,n),this._callbacks||(this._callbacks={}),this._callbacks[e]||(this._callbacks[e]=[]),this._callbacks[e].push(n),this},e.prototype.off=function(e,n){if(t("off",e,n),this._callbacks)switch(arguments.length){case 0:this._callbacks={};break;case 1:delete this._callbacks[e];break;default:var s=this._callbacks[e];if(!s)return;var i=s.indexOf(n);~i&&s.splice(i,1)}return this},e.prototype.emit=function(e,n){if(t("emit",e,n),this._callbacks){var s=this._callbacks[e]||[];s=s.concat(this._callbacks["*"]||[]);for(var i=0;i<s.length;i++)s[i].call(this,n,e)}return this}},{}],6:[function(require,module,exports){"use strict";function e(n){return this instanceof e?void(this._=new t(n)):new e(n)}function t(e){this.id="threadsmanager",this.registry={},this.threads={},this.messenger=new s(this.id,"[Manager]").handle("connect",this.onconnect,this),r.addEventListener("message",this.messenger.parse),this.register(e),i("intialized")}var n=require("./child-thread"),s=require("./messenger");module.exports=e;var i=function(){},r=new BroadcastChannel("threadsmanager");e.prototype.destroy=function(){this._.destroy()},t.prototype.destroy=function(){i("destroy"),r.removeEventListener("message",this.messenger.parse),this.destroyThreads(),delete this.registry,delete this.threads},t.prototype.destroyThreads=function(){i("destroy threads");for(var e in this.threads)this.destroyThread(this.threads[e])},t.prototype.register=function(e){i("register",e);for(var t in e)e[t].name=t,this.registry[t]=e[t]},t.prototype.onconnect=function(e){i("on connect");var t=e.data,n=this.registry[t.service];if(!n)return i('"%s" not managed here',t.service);var s=this,r=t.client,o=n.contract,a=this.getThread(n);e.respond(a.getService(n.name).then(function(e){return s.connect(r,e,o)}))},t.prototype.connect=function(e,t,n){return i("connect",t,e,n),this.messenger.request(r,{type:"connect",recipient:t.id,data:{client:e,service:t.name,contract:n}})},t.prototype.getThread=function(e){i("get thread",e);var t=this.threads[e.src];return t||this.createThread(e)},t.prototype.createThread=function(e){i("create thread",e);var t=new n(e),s=this;return this.threads[t.src]=t,t.on("redundant",function r(){t.off("redundant",r),s.destroyThread(t)}),t},t.prototype.destroyThread=function(e){i("destroy thread"),e.destroy(),delete this.threads[e.src]}},{"./child-thread":2,"./messenger":7}],7:[function(require,module,exports){"use strict";function e(e,t){this.id=e,this.name=t,this.handlers={},this.pending={},this.history=new Array(10),this.parse=this.parse.bind(this),i("initialized",this.name)}function t(e){var t=e.data,n=t.data;this.id=n.id,this.channel=e.source||e.target,this.sender=t.sender,this.type=n.type,this.data=n.data,this.responded=!1}function n(e,t){i("send",e,t);var n="Window"===e.constructor.name,r={type:t.type,id:s.uuid(),recipient:t.recipient||"*",sender:t.sender,data:t.data};n?e.postMessage(r,"*"):e.postMessage(r)}var s=require("./utils"),i=function(){};module.exports=e,e.prototype.handle=function(e,t,n){return this.handlers[e]={fn:t,ctx:n},this},e.prototype.unhandle=function(e){return delete this.handlers[e],this},e.prototype.parse=function(e){var t=e.data;if(this.isRecipient(t)&&!this.hasRead(t)){i("parse",this.name,e);var n=this["on"+t.type];n&&(n.call(this,e),this.read(t))}},e.prototype.request=function(e,t){i("request",this.name,t);var r=s.deferred(),o=s.uuid();return n(e,{type:"request",sender:this.id,recipient:t.recipient,data:{id:o,type:t.type,data:t.data}}),this.pending[o]=r,r.promise},e.prototype.push=function(e,t){i("push",e,t),n(e,{type:"push",sender:this.id,recipient:t.recipient,data:{type:t.type,data:t.data}})},e.prototype.onrequest=function(e){i("on request",e);var n=new t(e),s=this.handlers[n.type];if(s)try{s.fn.call(s.ctx,n)}catch(e){n.respond(e),console.error(e)}},e.prototype.onresponse=function(e){i("on response",this.name,n);var t=e.data,n=t.data,s=n.request,r=this.pending[s];if(!r)return i("no promise",this.pending);var o=n.result,a={fulfilled:"resolve",rejected:"reject"}[o.state],c=o.value||o.reason;r[a](c),delete this.pending[s]},e.prototype.onpush=function(e){var t=e.data,n=t.data;i("on push",n);var s=this.handlers[n.type];s&&s.fn.call(s.ctx,n.data)},e.prototype.isRecipient=function(e){var t=e.recipient;return t===this.id||"*"===t},e.prototype.read=function(e){this.history.push(e.id),this.history.shift()},e.prototype.hasRead=function(e){return!!~this.history.indexOf(e.id)},t.prototype.respond=function(e){function t(e){i("resolved",e),r({state:"fulfilled",value:e})}function s(e){i("rejected",e.message),r({state:"rejected",reason:e.message||e})}function r(e){n(o.channel,{type:"response",recipient:o.sender,data:{request:o.id,result:e}})}if(i("respond"),!this.responded){this.responded=!0;var o=this;return e instanceof Error&&s(e),Promise.resolve(e).then(t,s)}}},{"./utils":11}],8:[function(require,module,exports){"use strict";function e(n){return this instanceof e?(this.name=n,this["private"]=new t(this),void a("initialized",this.name)):new e(n)}function t(e){a("initialize",e),this["public"]=e,this.name=e.name,this.id=o.uuid(),this.contract=null,this.methods={},this.channels={},this.streams={},this.activeStreams={},this.messenger=new i(this.id,"[service]").handle("connect",this.onconnect,this).handle("stream",this.onstream,this).handle("streamcancel",this.onstreamcancel,this).handle("method",this.onmethod,this).handle("disconnect",this.ondisconnect,this),this.listen(),setTimeout(this.ready.bind(this))}function n(e){var t=[].slice.call(arguments,1);return new Error({1:'method "'+t[0]+'" not defined in the contract',2:'expected method " '+t[0]+'" to be called with '+t[1]+" arguments",3:'unknown request type: "'+t[0]+'"',4:'method "'+t[0]+"\" doesn't exist",5:"arguments types don't match contract",6:'stream "'+t[0]+"\" doesn't exist"})}var s=require("../thread-global"),i=require("../messenger"),r=require("./stream"),o=require("../utils");module.exports=e,module.exports.Stream=r;var a=function(){},c=new BroadcastChannel("threadsmanager");e.prototype.method=function(e,t){return this["private"].addMethod(e,t),this},e.prototype.stream=function(e,t){return this["private"].addStream(e,t),this},e.prototype.contract=function(e){return this["private"].setContract(e),this},e.prototype.broadcast=function(e,t){return this["private"].broadcast(e,t),this},t.prototype.onmethod=function(e){a("method",e.data);var t=e.data,s=this.methods[t.name];if(!s)throw n(4,t.name);this.checkMethodCall(t);var i=s.apply(this["public"],t.args);e.respond(i)},t.prototype.onstream=function(e){a("stream",e.data);var t=e.data,s=this.streams[t.name],i=e.sender;if(!s)throw n(6,t.name);var o=t.id,c=new r({id:o,channel:this.channels[i],serviceId:this.id,clientId:i});this.activeStreams[o]=c,s.apply(this["public"],[c].concat(t.args)),e.respond()},t.prototype.onstreamcancel=function(e){var t=e.data,n=t.id,s=this.activeStreams[n];delete this.activeStreams[n],e.respond(s._.cancel(t.reason))},t.prototype.ready=function(){a("ready"),s.serviceReady(this)},t.prototype.onconnect=function(e){var t=e.data,n=t.client,i=t.contract,r=t.service;if(n&&r===this.name&&!this.channels[n]){a("on connect",this.id,t);var o=new BroadcastChannel(n);o.onmessage=this.messenger.parse,this.channels[n]=o,this.setContract(i),s.connection("inbound"),a("connected",n),e.respond({id:this.id,name:this.name})}},t.prototype.ondisconnect=function(e){var t=e.data;if(t&&this.channels[t]){a("on disconnect",t);var n=o.deferred();n.resolve(),n.promise.then(function(){return e.respond()}).then(function(){a("disconnected",t),this.channels[t].close(),delete this.channels[t],s.disconnection("inbound")}.bind(this))}},t.prototype.setContract=function(e){e&&(this.contract=e,a("contract set",e))},t.prototype.addMethod=function(e,t){this.methods[e]=t},t.prototype.addStream=function(e,t){this.streams[e]=t},t.prototype.checkMethodCall=function(e){a("check method call",e);var t=e.name,s=e.args;if(this.contract){var i,r=this.contract.methods[t];if(r?s.length!==r.length?i=n(2,t,r.length):o.typesMatch(s,r)||(i=n(5)):i=n(1,t),i)throw i}},t.prototype.listen=function(){c.addEventListener("message",this.messenger.parse),s.on("message",this.messenger.parse)},t.prototype.broadcast=function(e,t){a("broadcast",e,t);for(var n in this.channels)this.messenger.push(this.channels[n],{type:"broadcast",recipient:n,data:{type:e,data:t}})}},{"../messenger":7,"../thread-global":10,"../utils":11,"./stream":9}],9:[function(require,module,exports){"use strict";function e(e){this._=new t(this,e)}function t(e,t){this.target=e,this.id=t.id,this.channel=t.channel,this.client=t.clientId,this.state="writable",this.messenger=new n(t.serviceId,"[ServiceStream]"),s("initialized",e,t)}var n=require("../messenger");module.exports=e;var s=function(){};e.prototype.cancel=function(e){var t=new TypeError("service should implement stream.cancel()");return Promise.reject(t)},e.prototype.abort=function(e){return s("abort",e),this._.post("abort","aborted",e)},e.prototype.write=function(e){return s("write",e),this._.post("write","writable",e)},e.prototype.close=function(){return s("close"),this._.post("close","closed")},t.prototype.validateState=function(e,t){if("writable"!==this.state){var n="Can't "+e+" on current state: "+this.state;return Promise.reject(new TypeError(n))}return this.state=t,Promise.resolve()},t.prototype.cancel=function(e){return this.validateState("cancel","canceled").then(function(){return this.target.cancel(e)}.bind(this))},t.prototype.post=function(e,t,n){return s("post",e,t,n),this.validateState(e,t).then(function(){s("validated",this.channel),this.messenger.push(this.channel,{type:"streamevent",recipient:this.client,data:{id:this.id,type:e,data:n}})}.bind(this))}},{"../messenger":7}],10:[function(require,module,exports){"use strict";function e(){this.id=t(),this.type=o.env(),this.isRoot=n(),this.manager=new BroadcastChannel("threadsmanager"),this.ports=[],this.services={},this.connections={inbound:0,outbound:0},this.messenger=new i(this.id,"[ThreadGlobal]").handle("ping",this.onPing,this),this.onmessage=this.onmessage.bind(this),this.listen(),this.ready(),a("initialized",this.id,this.type,this.isRoot)}function t(){return o.query(location.search).pid||s()&&window.name||o.uuid()}function n(){return s()&&window.parent===window}function s(){return"undefined"!=typeof window}var i=require("./messenger"),r=require("./emitter"),o=require("./utils"),a=function(){};const c={1:"Unknown connection type",2:"Service already defined"};e.prototype=Object.create(r.prototype),e.prototype.listen=function(){switch(a("listen"),this.type){case"sharedworker":addEventListener("connect",function(e){a("port connect");var t=e.ports[0];this.ports.push(t),t.onmessage=this.onmessage,t.start()}.bind(this));break;case"worker":case"window":addEventListener("message",this.onmessage)}},e.prototype.ready=function(){a("ready",this.id),this.messenger.push(this,{type:"threadready",data:this.serialize()})},e.prototype.onPing=function(e){a("on ping"),e.respond(this.serialize())},e.prototype.serialize=function(){return{id:this.id,services:this.services}},e.prototype.onmessage=function(e){a("on message",e),this.messenger.parse(e),this.emit("message",e)},e.prototype.serviceReady=function(e){if(a("service ready",e),this.services[e.name])throw new Error('Service "'+e.name+'" already defined');this.services[e.name]={id:e.id,name:e.name},this.messenger.push(this,{type:"serviceready",data:this.services[e.name]})},e.prototype.postMessage=function(e){switch(a("postMessage (%s)",this.type,e),this.type){case"worker":postMessage(e);break;case"sharedworker":this.ports.forEach(function(t){t.postMessage(e)});break;case"window":window.parent.postMessage(e,"*")}},e.prototype.connection=function(e){if(!(e in this.connections))throw Error(c[1]);this.connections[e]++,a("connection",e,this.connections[e]),this.check()},e.prototype.disconnection=function(e){if(!(e in this.connections))throw Error(c[1]);this.connections[e]--,a("disconnection",e,this.connections[e]),this.check()},e.prototype.check=function(){this.isRedundant()&&(a("redundant"),this.messenger.push(this,{type:"redundant"}))},e.prototype.isRedundant=function(){return!this.isRoot&&this.isDetached()},e.prototype.isDetached=function(){return!this.connections.inbound},module.exports=new e},{"./emitter":5,"./messenger":7,"./utils":11}],11:[function(require,module,exports){"use strict";exports.uuid=function(){var e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:7&n|8).toString(16)})},exports.typesMatch=function(e,t){for(var n=0,s=e.length;s>n;n++)if(typeof e[n]!==t[n])return!1;return!0},exports.deferred=function(){var e={};return e.promise=new Promise(function(t,n){e.resolve=t,e.reject=n}),e},exports.query=function(e){var t={};return e.replace("?","").split("&").forEach(function(e){var n=e.split("=");t[n[0]]=n[1]}),t},exports.env=function(){return{Window:"window",SharedWorkerGlobalScope:"sharedworker",DedicatedWorkerGlobalScope:"worker",ServiceWorkerGlobalScope:"serviceworker"}[self.constructor.name]||"unknown"}},{}]},{},[1])(1)});